<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowing Coach Feedback Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- V8 Firebase Modules: Highly stable global API for single-file deployment -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* Define a custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React App will be mounted here -->
    </div>

    <!-- Main React Component and Logic -->
    <script type="text/babel">
        // --- Firebase V8 Access (Simple Global API) ---
        // V8 Access to server timestamp
        const serverTimestamp = () => firebase.firestore.FieldValue.serverTimestamp();

        // --- Lucide Icons Mock ---
        const Clipboard = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="4" width="6" height="4" rx="1" /><path d="M10 20h4M12 20v-8M18 10h-2M6 10H4M16 10H8M21 10V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8zM12 14v4" /></svg>;
        const Save = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /><path d="M12 17v-4h-4" /></svg>;
        const Loader = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>;
        const XCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="m15 9-6 6" /><path d="m9 9 6 6" /></svg>;
        const Users = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>;
        const Search = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>;
        const FileText = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>;


        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Global Firebase Configuration and Constants ---
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
        
        // Helper function to format Firestore data (especially timestamps)
        const formatFeedbackData = (data) => {
            const formattedData = { ...data };
            if (formattedData.createdAt && formattedData.createdAt.toDate) {
                formattedData.date = formattedData.createdAt.toDate().toISOString().split('T')[0];
            }
            // Ensure scores are numbers
            for (const key in formattedData) {
                if (rubricData.some(r => r.key === key) && formattedData[key].score !== undefined) {
                    formattedData[key].score = Number(formattedData[key].score);
                }
            }
            return formattedData;
        };

        // Rubric data structure remains the same
        const rubricData = [
        { key: 'UnderstandsSport', title: 'Understands the Sport', subtitle: '(Technical, Tactical, Rules)', levels: [ { score: 0, description: 'Open to Learning' }, { score: 1, description: 'Emerging (Starting to notice techniques and rules)' }, { score: 2, description: 'Exploring (Beginning to apply knowledge)' }, { score: 3, description: 'Applying (Using knowledge with intent)' }, { score: 4, description: 'Integrating (Adapting technical/tactical elements confidently)' }, { score: 5, description: 'Leading (Mentoring and sharing sport knowledge)' }, ]},
        { key: 'UnderstandsSelf', title: 'Understands Self', subtitle: '(Leadership, Philosophy, Communication)', levels: [ { score: 0, description: 'Open to Learning' }, { score: 1, description: 'Emerging (Starting to reflect on personal style)' }, { score: 2, description: 'Exploring (Becoming aware of coaching role/impact)' }, { score: 3, description: 'Applying (Established philosophy and starting to implement)' }, { score: 4, description: 'Integrating (Adapting communication and style to suit others)' }, { score: 5, description: 'Leading (Supporting others through clear, authentic leadership)' }, ]},
        { key: 'UnderstandsEnvironment', title: 'Understands Environment', subtitle: '(Culture, Learning Space)', levels: [ { score: 0, description: 'Open to Learning' }, { score: 1, description: 'Emerging (Trying new inclusion strategies, noticing dynamics)' }, { score: 2, description: 'Exploring (Beginning to consider environment effects)' }, { score: 3, description: 'Applying (Creating space that supports trust and growth)' }, { score: 4, description: 'Integrating (Shaping a positive culture through deliberate actions)' }, { score: 5, description: 'Leading (Supporting athletes in co-creating a positive environment)' }, ]},
        { key: 'UnderstandsLearning', title: 'Understands Learning', subtitle: '(Reflection, Planning, Pedagogy)', levels: [ { score: 0, description: 'Open to Learning' }, { score: 1, description: 'Emerging (Starting to think about how people learn)' }, { score: 2, description: 'Exploring (Noticing different learning preferences)' }, { score: 3, description: 'Applying (Planning sessions with learning styles in mind - Athlete-centred)' }, { score: 4, description: 'Integrating (Adapting activities based on reflection and feedback)' }, { score: 5, description: 'Leading (Designing learning based on individual needs and goals)' }, ]},
        { key: 'UnderstandsDevelopment', title: 'Understands Development', subtitle: '(Age & Stage, Feedback)', levels: [ { score: 0, description: 'Open to Learning' }, { score: 1, description: 'Emerging (Reflecting on sessions relative to age and stage)' }, { score: 2, description: 'Exploring (Building awareness of how athletes develop)' }, { score: 3, description: 'Applying (Providing purposeful feedback and clear expectations)' }, { score: 4, description: 'Integrating (Balancing support with challenge in meaningful ways)' }, { score: 5, description: 'Leading (Transforming performance through reflective support)' }, ]},
        ];

        const initialFeedbackState = {
        coachName: '',
        date: new Date().toISOString().split('T')[0],
        sessionTopic: '',
        ...Object.fromEntries(rubricData.map(item => [item.key, { score: 0, notes: '' }])),
        actionPlan: '',
        createdAt: null,
        };

        // --- Custom Components ---

        const RubricRow = ({ category, feedback, updateFeedback }) => {
        const { key, title, subtitle, levels } = category;
        const { score, notes } = feedback[key] || {score: 0, notes: ''}; // Ensure fallback for newly loaded data

        return (
            <div className="border border-gray-200 p-4 rounded-xl shadow-md bg-white mb-6">
            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
            <p className="text-sm text-indigo-600 mb-3">{subtitle}</p>

            {/* Score Selection (Radio Group) */}
            <div className="flex flex-wrap gap-2 mb-4 bg-indigo-500/10 p-2 rounded-lg">
                {levels.map((level) => (
                <button
                    key={level.score}
                    onClick={() => updateFeedback(key, 'score', level.score)}
                    className={`flex-1 min-w-[50px] py-2 px-1 text-center font-semibold rounded-lg transition-all duration-200 ease-in-out border-2 ${
                    score === level.score
                        ? 'bg-indigo-700 text-white border-indigo-900 shadow-lg scale-[1.02]'
                        : 'bg-white text-indigo-700 border-indigo-300 hover:bg-indigo-100'
                    }`}
                >
                    {level.score}
                </button>
                ))}
            </div>

            {/* Current Level Description */}
            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-4">
                <p className="font-semibold text-gray-600">Current Level ({score}):</p>
                <p className="text-sm text-gray-800">
                {levels.find(l => l.score === score)?.description || 'No score selected.'}
                </p>
            </div>

            {/* Notes/Comments Textarea */}
            <label htmlFor={`${key}-notes`} className="block text-sm font-medium text-gray-700 mb-1">
                Examples, Reflections, and Comments:
            </label>
            <textarea
                id={`${key}-notes`}
                rows="4"
                value={notes}
                onChange={(e) => updateFeedback(key, 'notes', e.target.value)}
                placeholder="Document specific examples and observations from the session..."
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base resize-none"
            />
            </div>
        );
        };

        // --- Load Sessions Modal Component ---
        const SessionLoaderModal = ({ isOpen, onClose, sessionsList, searchTerm, setSearchTerm, onLoadSessions, onSelectSession, isFetching }) => {
            
            const handleSearch = (e) => {
                e.preventDefault();
                onLoadSessions();
            };
            
            return (
                <div className={`fixed inset-0 z-50 overflow-y-auto ${isOpen ? 'block' : 'hidden'}`}>
                    <div className="flex items-center justify-center min-h-screen p-4 text-center">
                        <div className="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" onClick={onClose}></div>
                        
                        <div className="inline-block w-full max-w-lg p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-xl">
                            <h3 className="text-2xl font-bold leading-6 text-gray-900 flex items-center mb-4">
                                <Search className="w-6 h-6 mr-2 text-indigo-600" />
                                Load Existing Session
                            </h3>
                            
                            <form onSubmit={handleSearch} className="mb-4 flex space-x-2">
                                <input
                                    type="text"
                                    placeholder="Search by Coach Name..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                />
                                <button
                                    type="submit"
                                    disabled={isFetching}
                                    className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400 flex items-center"
                                >
                                    {isFetching ? <Loader className="w-5 h-5 mr-2 animate-spin" /> : <Search className="w-5 h-5 mr-2" />}
                                    Search
                                </button>
                            </form>

                            <div className="mt-4 max-h-80 overflow-y-auto border border-gray-200 rounded-lg">
                                {isFetching && sessionsList.length === 0 && (
                                    <div className="p-4 text-center text-gray-500 flex items-center justify-center">
                                        <Loader className="w-4 h-4 mr-2 animate-spin" /> Fetching sessions...
                                    </div>
                                )}
                                {!isFetching && sessionsList.length === 0 && searchTerm && (
                                    <div className="p-4 text-center text-gray-500">
                                        No sessions found for "{searchTerm}".
                                    </div>
                                )}
                                {sessionsList.map((session) => (
                                    <div
                                        key={session.id}
                                        onClick={() => onSelectSession(session)}
                                        className="p-3 border-b border-gray-100 hover:bg-indigo-50 cursor-pointer flex justify-between items-center transition duration-150"
                                    >
                                        <div>
                                            <p className="font-semibold text-gray-800">{session.coachName}</p>
                                            <p className="text-xs text-gray-500">{session.sessionTopic || 'No topic specified'}</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm text-indigo-600 font-medium">{session.date}</span>
                                            <FileText className="w-4 h-4 text-indigo-400" />
                                        </div>
                                    </div>
                                ))}
                                {!isFetching && sessionsList.length > 0 && (
                                    <div className="text-center p-2 text-sm text-gray-600 bg-gray-50 border-t">
                                        {sessionsList.length} total sessions found.
                                    </div>
                                )}
                            </div>
                            
                            <div className="mt-5 text-right">
                                <button
                                    type="button"
                                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150"
                                    onClick={onClose}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application Component ---
        const App = () => {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false);
        const [feedback, setFeedback] = useState(initialFeedbackState);
        const [feedbackId, setFeedbackId] = useState(null);
        const [saveStatus, setSaveStatus] = useState('saved');
        
        // Load Session States
        const [isLoadModalOpen, setIsLoadModalOpen] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [sessionsList, setSessionsList] = useState([]);
        const [isFetching, setIsFetching] = useState(false);

        const collectionPath = `artifacts/${appId}/public/data/rowing_coach_feedback`;

        // 1. Firebase Initialization and Authentication
        useEffect(() => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                setUserId('OFFLINE_USER_' + (Math.random() * 1000).toFixed(0));
                setIsAuthReady(true); 
                return;
            }
            try {
                const app = firebase.initializeApp(firebaseConfig);
                const firestore = app.firestore();
                const authInstance = app.auth();

                setDb(firestore);
                setAuth(authInstance);

                const unsubscribe = authInstance.onAuthStateChanged(async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        try {
                            if (initialAuthToken) {
                                await authInstance.signInWithCustomToken(initialAuthToken);
                            } else {
                                await authInstance.signInAnonymously();
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                setIsAuthReady(true);
            }
        }, []);

        // 2. Data Persistence (Save) - Logic remains the same
        const saveFeedback = useCallback(async (currentFeedback, id) => {
            if (!db || userId.startsWith('OFFLINE') || !currentFeedback.coachName) {
            setSaveStatus('saved');
            return;
            }

            setSaveStatus('saving');
            const dataToSave = {
            ...currentFeedback,
            updatedAt: serverTimestamp(),
            trainerId: userId,
            };

            let docRef;
            if (id) {
                docRef = db.collection(collectionPath).doc(id);
            } else {
                docRef = db.collection(collectionPath).doc();
            }

            try {
            if (id) {
                await docRef.update(dataToSave);
            } else {
                if (docRef.id) {
                    await docRef.set({ ...dataToSave, createdAt: serverTimestamp() });
                    setFeedbackId(docRef.id);
                }
            }
            setSaveStatus('saved');
            } catch (e) {
            console.error("Error saving document: ", e);
            setSaveStatus('error');
            }
        }, [db, userId, collectionPath]);

        // 3. Auto-Save Effect (Debounced saving) - Logic remains the same
        useEffect(() => {
            if (!db || !isAuthReady || !feedback.coachName) return;

            const handler = setTimeout(() => {
            saveFeedback(feedback, feedbackId);
            }, 1000);

            return () => {
            clearTimeout(handler);
            };
        }, [feedback, feedbackId, db, isAuthReady, saveFeedback]);


        // 4. Update Handler - Logic remains the same
        const handleUpdate = (categoryKey, field, value) => {
            setFeedback(prev => {
            if (categoryKey === 'meta') {
                return { ...prev, [field]: value };
            }
            return {
                ...prev,
                [categoryKey]: {
                ...prev[categoryKey],
                [field]: value,
                },
            };
            });
        };

        const handleNewSession = () => {
            setFeedback({
                ...initialFeedbackState,
                date: new Date().toISOString().split('T')[0],
            });
            setFeedbackId(null);
            setSaveStatus('saved');
        };

        // --- NEW: Load Sessions Logic ---

        // Function to search Firestore for sessions
        const loadSessions = useCallback(async () => {
            if (!db || userId.startsWith('OFFLINE') || !searchTerm) return;
            setIsFetching(true);
            setSessionsList([]);

            try {
                // V8 Query: Filter by coachName and order by creation date
                const querySnapshot = await db.collection(collectionPath)
                    .where('coachName', '==', searchTerm)
                    .orderBy('createdAt', 'desc')
                    .get();

                const loadedSessions = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    loadedSessions.push({
                        id: doc.id,
                        ...formatFeedbackData(data),
                    });
                });
                
                setSessionsList(loadedSessions);
            } catch (error) {
                console.error("Error loading sessions:", error);
                setSessionsList([]);
            } finally {
                setIsFetching(false);
            }
        }, [db, userId, collectionPath, searchTerm]);

        // Function to load selected session data into the main state
        const loadSelectedSession = useCallback((session) => {
            // Reconstruct the state structure, ensuring all rubric keys are present
            const loadedState = { ...initialFeedbackState, ...session };
            
            // Set the state and close the modal
            setFeedback(loadedState);
            setFeedbackId(session.id);
            setIsLoadModalOpen(false);
            setSaveStatus('saved');
        }, []);


        // 5. Rubric Category Component Mapping - Logic remains the same
        const rubricRows = useMemo(() => rubricData.map(category => (
            <RubricRow
            key={category.key}
            category={category}
            feedback={feedback}
            updateFeedback={handleUpdate}
            />
        )), [feedback]);

        const ScoreDisplay = ({ score }) => {
            const color = {
            0: 'text-gray-400', 1: 'text-red-500', 2: 'text-yellow-500',
            3: 'text-green-500', 4: 'text-blue-500', 5: 'text-indigo-600'
            }[score];

            return <span className={`font-extrabold ${color}`}>{score}</span>;
        }

        const overallScore = useMemo(() => {
            const scores = rubricData.map(c => feedback[c.key]?.score || 0);
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            return isNaN(avg) ? 0 : avg.toFixed(1);
        }, [feedback]);


        if (!isAuthReady) {
            return (
            <div className="flex items-center justify-center h-screen bg-gray-50">
                <Loader className="animate-spin text-indigo-500 w-8 h-8 mr-3" />
                <p className="text-lg text-gray-700">Loading Coach Trainer Environment...</p>
            </div>
            );
        }
        
        // Render the App 
        return (
            <div className="min-h-screen bg-gray-50 font-sans p-4 sm:p-6 lg:p-8">
            <div className="max-w-4xl mx-auto">
                {/* Header and Controls */}
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 p-4 bg-white shadow-xl rounded-2xl border-t-4 border-indigo-600">
                <div>
                    <h1 className="text-3xl font-extrabold text-gray-900 flex items-center">
                    <Users className="w-8 h-8 text-indigo-600 mr-3" />
                    Rowing Coach 1:1 Feedback
                    </h1>
                    <p className="text-sm text-gray-500 mt-1">
                    Trainer ID: {userId || 'N/A - Offline'}
                    </p>
                </div>
                <div className="mt-4 md:mt-0 flex space-x-3">
                    <button
                        onClick={() => setIsLoadModalOpen(true)}
                        className="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 flex items-center text-sm"
                    >
                        <Search className="w-4 h-4 mr-2" />
                        Load Session
                    </button>
                    <button
                    onClick={handleNewSession}
                    className="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150 flex items-center text-sm"
                    >
                    New Session
                    </button>
                    <div className={`px-4 py-2 rounded-lg font-medium text-sm flex items-center ${
                        saveStatus === 'saving' ? 'bg-yellow-100 text-yellow-800' :
                        saveStatus === 'error' ? 'bg-red-100 text-red-800' :
                        'bg-indigo-100 text-indigo-800'
                    }`}
                    >
                    {saveStatus === 'saving' && <Loader className="w-4 h-4 mr-2 animate-spin" />}
                    {saveStatus === 'error' && <XCircle className="w-4 h-4 mr-2" />}
                    {saveStatus === 'saved' && <Save className="w-4 h-4 mr-2" />}
                    {saveStatus.charAt(0).toUpperCase() + saveStatus.slice(1)}
                    </div>
                </div>
                </header>

                {/* Session Details Card */}
                <section className="bg-white p-6 rounded-2xl shadow-xl mb-8 border-l-4 border-indigo-500">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">Session Information</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                    <label htmlFor="coachName" className="block text-sm font-medium text-gray-700 mb-1">Coach's Name</label>
                    <input
                        type="text"
                        id="coachName"
                        value={feedback.coachName}
                        onChange={(e) => handleUpdate('meta', 'coachName', e.target.value)}
                        placeholder="Coach's Name (Required to Save)"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base"
                    />
                    </div>
                    <div>
                    <label htmlFor="date" className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                        type="date"
                        id="date"
                        value={feedback.date}
                        onChange={(e) => handleUpdate('meta', 'date', e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base"
                    />
                    </div>
                    <div className="md:col-span-1">
                    <label htmlFor="topic" className="block text-sm font-medium text-gray-700 mb-1">Session Topic/Focus</label>
                    <input
                        type="text"
                        id="topic"
                        value={feedback.sessionTopic}
                        onChange={(e) => handleUpdate('meta', 'sessionTopic', e.target.value)}
                        placeholder="e.g., Technical Sculling Drills"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base"
                    />
                    </div>
                </div>
                </section>

                {/* Rubric Scoring Section */}
                <section className="mb-8">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">Quality Coaching Rubric Assessment</h2>
                {rubricRows}
                </section>

                {/* Summary and Action Plan */}
                <section className="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-indigo-700">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">Summary & Action Plan</h2>

                <div className="mb-6 p-4 bg-indigo-500/10 rounded-lg flex justify-between items-center shadow-inner">
                    <p className="text-lg font-medium text-gray-700">Overall Average Score:</p>
                    <p className="text-4xl font-extrabold text-indigo-700">
                    <ScoreDisplay score={overallScore} />
                    <span className="text-xl font-normal text-indigo-500"> / 5.0</span>
                    </p>
                </div>

                <label htmlFor="actionPlan" className="block text-sm font-medium text-gray-700 mb-1">
                    Key Takeaways and Next Steps (Action Plan):
                </label>
                <textarea
                    id="actionPlan"
                    rows="6"
                    value={feedback.actionPlan}
                    onChange={(e) => handleUpdate('meta', 'actionPlan', e.target.value)}
                    placeholder="Summarize the coaching session and detail 2-3 specific, measurable actions for the coach to focus on before the next check-in."
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base resize-none"
                />
                </section>

                <footer className="mt-8 text-center text-sm text-gray-500 flex justify-center items-center">
                <p className="mr-2">Document ID: {feedbackId || 'New Document'}</p>
                <Clipboard
                    className="w-4 h-4 cursor-pointer hover:text-indigo-500"
                    onClick={() => navigator.clipboard.writeText(feedbackId || 'No ID yet').catch(err => console.error('Could not copy text: ', err))}
                    title="Copy Document ID"
                />
                </footer>

                {/* Session Loader Modal */}
                <SessionLoaderModal 
                    isOpen={isLoadModalOpen}
                    onClose={() => setIsLoadModalOpen(false)}
                    sessionsList={sessionsList}
                    searchTerm={searchTerm}
                    setSearchTerm={setSearchTerm}
                    onLoadSessions={loadSessions}
                    onSelectSession={loadSelectedSession}
                    isFetching={isFetching}
                />

            </div>
            </div>
        );
        };

        // --- Render the App ---
        const container = document.getElementById('root');
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />); 
        } else {
            console.error("Root element not found.");
        }
    </script>
</body>
</html>
