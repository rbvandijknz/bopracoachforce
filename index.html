<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOP Rowing Coach Development</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .login-card {
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"><div class="flex justify-center items-center h-screen bg-gray-50"><p class="text-lg text-gray-700">Initializing Application...</p></div></div>

    <!-- Add/Edit Coach Modal -->
    <div id="coach-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add New Coach</h2>
            <input type="hidden" id="coach-id-input">
            <div class="space-y-4">
                <div>
                    <label for="coach-name-input" class="block text-sm font-medium text-gray-700">Coach Name</label>
                    <input type="text" id="coach-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                <!-- Removed Coach Email Input -->
                <div>
                    <label for="coach-club-select" class="block text-sm font-medium text-gray-700">Club</label>
                    <select id="coach-club-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-coach-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-coach-button" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69]">Save Coach</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="restore-input" class="hidden" accept=".json">

    <!-- Script tags moved here, added prop-types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.error('Failed to load React from cdnjs')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.error('Failed to load ReactDOM from cdnjs')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.error('Failed to load prop-types from cdnjs')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.1.9/Recharts.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.error('Failed to load Recharts from cdnjs')"></script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, query, where, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- CONSTANTS ---
        const ADMIN_EMAIL = 'merowing@xtra.co.nz'; // Still used for login check
        const firebaseConfig = {
            apiKey: "AIzaSyAVbGWN3LclrUZMtv-L7x0D8HF7OQ3viK8",
            authDomain: "bopracoachfeedback.firebaseapp.com",
            projectId: "bopracoachfeedback",
            storageBucket: "bopracoachfeedback.appspot.com",
            messagingSenderId: "967552327697",
            appId: "1:967552327697:web:f3a2e3ffa5d6c6a3f611b0",
            measurementId: "G-NRQ2HSJGT6"
        };
        
        // --- UPDATED RUBRIC DATA ---
        const rubricData = {
          "Understands People": { 
              description: "(build relationships, athlete-centred, observations)", 
              levels: [
                  "Beginning to recognise the value of connection and individual needs.", // 0
                  "Starting to purposely observe how athletes behave and interact with others and self.", // 1
                  "Building trust and ability to communicate with athletes.", // 2
                  "Adjusting coaching based on what is seen and heard from athletes.", // 3
                  "Creating meaningful connections through thoughtful observation and response.", // 4
                  "Guiding others to connect deeply and coach with empathy and awareness." // 5
              ] 
          },
          "Understands the Sport": { 
              description: "(technical, tactical, rules)", 
              levels: [
                  "Open to learning sport-specific knowledge.", // 0
                  "Starting to notice techniques and rules in action.", // 1
                  "Beginning to apply knowledge of techniques and rules with athletes.", // 2
                  "Using sport knowledge intentionally with athletes.", // 3
                  "Adapting technical/tactical elements confidently.", // 4
                  "Mentoring and sharing sport knowledge with others;" // 5 
              ] 
          },
          "Understands Self": { 
              description: "(leadership, philosophy, self-awareness, communication)", 
              levels: [
                  "Becoming aware of the coaching role and its impact.", // 0
                  "Noticing different coaching styles and effects.", // 1
                  "Starting to reflect on personal coaching style and values.", // 2
                  "Established a coaching philosophy and starting to implement.", // 3
                  "Adapting communication and coaching style to suit others' needs.", // 4
                  "Supporting others through clear, authentic leadership." // 5
              ] 
          },
          "Understands Environment": { 
              description: "(culture, learning space)", 
              levels: [
                  "Beginning to consider how environment affects learning.", // 0
                  "Noticing group dynamics and inclusion opportunities.", // 1
                  "Trying new strategies to include and engage all athletes.", // 2
                  "Creating space that supports trust and growth.", // 3
                  "Shaping a positive culture through deliberate actions.", // 4
                  "Supporting athletes in co-creating a positive environment." // 5
              ] 
          },
          "Understands Learning": { 
              description: "(reflection, planning, pedagogy/andragogy)", 
              levels: [
                  "Starting to think about how people learn.", // 0
                  "Noticing different learning preferences and athlete needs.", // 1
                  "Planning sessions with learning styles and athlete needs in mind.", // 2
                  "Adapting activities based on reflection and feedback.", // 3
                  "Applying learning theory with confidence.", // 4
                  "Designing learning based on individual needs and goals." // 5
              ] 
          },
          "Understands Development": { 
              description: "(age & stage, feedback, development)", 
              levels: [
                  "Building awareness of how athletes develop.", // 0
                  "Reflecting on sessions relative to age and stage.", // 1
                  "Planning sessions with the development needs of age and stage in mind.", // 2
                  "Providing purposeful feedback and clear expectations relative to age and stage.", // 3 
                  "Balancing support with challenge in meaningful ways.", // 4
                  "Transforming performance through reflective support." // 5
              ] 
          }
        };
        // --- END UPDATED RUBRIC DATA ---

        const levelNames = ["Emerging", "Exploring", "Developing", "Applying", "Integrating", "Leading"];
        const clubs = ["Bay of Plenty Coast", "Rotorua", "Taupo", "Tauranga", "Whakatane", "Tauranga Boys' College"];
        
        let app;
        let db;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Initialized Successfully");
        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600">Failed to initialize Firebase. Check console for details.</div>`;
            throw new Error("Firebase init failed"); 
        }

        // --- APPLICATION STATE (Simplified) ---
        let state = {
            authReady: false, 
            loading: false, 
            loadingMessage: "Initializing Application...", 
            user: null, // Only admin user will populate this
            // isAdmin removed, coachProfileNotFound removed
            coaches: {}, 
            currentView: 'coachList', 
            selectedCoachId: null, 
            selectedSession: null,
            searchQuery: '',
        };
        
        const root = document.getElementById('app');
        let currentUserId = null; 

        // --- STATE MANAGEMENT & RENDERING ---
        function setState(newState) {
            console.log("Setting State:", newState); 
            state = { ...state, ...newState };
            renderApp();
        }

        function renderApp() {
            root.innerHTML = ''; 
            
            if (!state.authReady || state.loading) { 
                 root.innerHTML = `<div class="flex justify-center items-center h-screen bg-gray-50"><p class="text-lg text-gray-700">${state.loadingMessage}</p></div>`;
                 return;
            }
            
            // If auth is ready but no user, show login screen
            if (!state.user) {
                root.appendChild(LoginScreen());
                return;
            }

            // User is logged in (must be admin), proceed to render main app views
            switch(state.currentView) { 
                case 'coachDetail':
                    if (state.selectedCoachId && state.coaches[state.selectedCoachId]) {
                         root.appendChild(CoachDetailScreen());
                    } else {
                         console.warn("Attempted to render detail view without valid selected coach, redirecting to list.");
                         setState({ currentView: 'coachList', selectedCoachId: null }); 
                    }
                    break;
                case 'sessionFeedback':
                    root.appendChild(SessionFeedbackScreen());
                    break;
                case 'athleteFeedback':
                    root.appendChild(AthleteFeedbackScreen());
                    break;
                case 'coachList': 
                default:
                     root.appendChild(CoachListScreen());
                    break;
            }
        }
        
        // --- DATA HANDLING & NAVIGATION ---
        window.handleSelectCoach = (coachId) => setState({ selectedCoachId: coachId, currentView: 'coachDetail' });
        window.handleSelectSession = (session) => setState({ selectedSession: session, currentView: 'sessionFeedback' });
        window.handleNewSession = () => {
             const newSessionTemplate = {
                 id: `session-${Date.now()}-${Math.random().toString(16).slice(2)}`, 
                 date: new Date().toISOString().split('T')[0], 
                 focus: '',
                 feedback: Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' })), 
                 summary: '', actionPlan: '', athleteFeedback: ''
             };
             setState({ selectedSession: newSessionTemplate, currentView: 'sessionFeedback' });
        };
        window.handleBack = () => {
            if (state.currentView === 'sessionFeedback') setState({ currentView: 'coachDetail' });
            else if (state.currentView === 'athleteFeedback') setState({ currentView: 'sessionFeedback' });
            else if (state.currentView === 'coachDetail') {
                 // Only admin can be on detail view, goes back to list
                 setState({ currentView: 'coachList', selectedCoachId: null });
            }
        };
       
        window.handleSaveSession = async (sessionData) => {
            if (!state.selectedCoachId) return; // Simplified check
            const coachRef = doc(db, 'coaches', state.selectedCoachId);
            const coachToUpdate = state.coaches[state.selectedCoachId]; 
            if (!coachToUpdate) return; // Simplified check

            // Ensure session feedback array matches current rubric structure
            const updatedFeedback = Object.keys(rubricData).map(cat => {
                const existingFeedback = (sessionData.feedback || []).find(f => f.category === cat);
                return existingFeedback || { category: cat, score: null, comments: '' }; 
            });
            sessionData.feedback = updatedFeedback;

            const sessionIndex = (coachToUpdate.sessions || []).findIndex(s => s.id === sessionData.id);
            let updatedSessions;

            if (sessionIndex > -1) {
                updatedSessions = coachToUpdate.sessions.map(s => s.id === sessionData.id ? sessionData : s);
            } else {
                updatedSessions = [...(coachToUpdate.sessions || []), sessionData];
            }
            
            try {
                await updateDoc(coachRef, { sessions: updatedSessions });
                console.log("Session saved successfully.");
                // Update local state is handled by Firestore listener generally, but force immediate update for navigation
                 const updatedCoaches = { ...state.coaches, [state.selectedCoachId]: { ...coachToUpdate, sessions: updatedSessions } };
                 setState({ coaches: updatedCoaches, selectedSession: sessionData, currentView: 'coachDetail' }); 

            } catch (error) {
                console.error("Error saving session: ", error);
                alert("Failed to save session feedback.");
            }
        };
        
        window.handleDeleteCoach = async (coachId, coachName) => {
             // Admin check implied as only admin sees the delete button
             if (confirm(`Are you sure you want to delete ${coachName}? This action cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, 'coaches', coachId));
                    console.log(`Coach ${coachName} deleted.`);
                } catch (error) {
                    console.error("Error deleting coach:", error);
                    alert("Failed to delete coach.");
                }
            }
        };

        window.handleLogout = async () => {
            console.log("Logging out...");
             // Reset state, ensure authReady stays true
             setState({ user: null, coaches: {}, currentView: 'coachList', loading: false, selectedCoachId: null, selectedSession: null, searchQuery: '', authReady: true }); 
            try {
                await signOut(auth);
                console.log("Sign out successful.");
                if (unsubscribe) {
                    console.log("Unsubscribing.");
                    unsubscribe(); 
                    unsubscribe = null;
                }
                 currentUserId = null; 
            } catch(error) {
                console.error("Error signing out:", error);
            }
        };
        
        window.handleSaveGoals = async () => {
            const goalsTextarea = document.getElementById('coach-goals-textarea');
            if (!goalsTextarea || !state.selectedCoachId) return;

            const newGoals = goalsTextarea.value;
            const coachRef = doc(db, 'coaches', state.selectedCoachId);

            try {
                await updateDoc(coachRef, { goals: newGoals });
                 // Update local state for immediate feedback
                 const updatedCoach = { ...state.coaches[state.selectedCoachId], goals: newGoals };
                 const updatedCoaches = { ...state.coaches, [state.selectedCoachId]: updatedCoach };
                 setState({ coaches: updatedCoaches }); 
                alert('Goals saved successfully!');
            } catch (error) {
                console.error("Error saving goals:", error);
                alert("Failed to save goals.");
            }
        };

        window.handleGetAthleteFeedback = () => {
            setState({ currentView: 'athleteFeedback' });
        };

        window.handleSaveAthleteFeedback = async () => {
            const feedbackText = document.getElementById('athlete-feedback-textarea').value;
            let currentSession = state.selectedSession ? JSON.parse(JSON.stringify(state.selectedSession)) : null; 
            if (!currentSession) {
                 console.error("Cannot save athlete feedback, no session selected.");
                 alert("Error: No session is currently selected.");
                 setState({ currentView: 'coachDetail' }); 
                 return;
            }
            currentSession.athleteFeedback = feedbackText;

            await handleSaveSession(currentSession); 
        };
        
        window.handleSearch = (query) => {
            setState({ searchQuery: query });
        };

         window.handleBackupData = () => {
            if (Object.keys(state.coaches).length === 0) {
                alert("There is no data to back up."); return;
            }
            try {
                const dataStr = JSON.stringify(state.coaches, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                link.download = `boprcf_backup_${date}.json`;
                link.href = url;
                link.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } catch (error) {
                console.error("Backup failed:", error);
                alert("Could not create backup file.");
            }
        };

        window.handleRestoreClick = () => {
            document.getElementById('restore-input').click();
        };


        // --- "COMPONENTS" (DOM element factories) ---
        function LoginScreen() {
             const el = document.createElement('div');
            el.className = 'flex flex-col justify-center items-center h-screen bg-gray-100 p-4';
            // Simplified: Removed Sign Up toggle
            el.innerHTML = `
                <div class="login-card bg-white p-8 rounded-xl shadow-lg text-center">
                    <img src="bop-logo.png" alt="Bay of Plenty Rowing Logo" class="w-48 mx-auto mb-6">
                    <h1 id="auth-title" class="text-2xl font-bold text-gray-800 mb-2">Admin Login</h1>
                    <p class="text-gray-600 mb-6">Enter admin credentials to access the coach development app.</p>
                    <div class="space-y-4 text-left">
                        <div>
                           <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                           <input id="email" type="email" required value="${ADMIN_EMAIL}" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"> 
                        </div>
                        <div>
                           <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                           <input id="password" type="password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        </div>
                    </div>
                    <button id="auth-button" class="mt-6 w-full bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69] transition-colors text-lg">
                        Sign In
                    </button>
                    <p id="error-message" class="text-red-500 mt-4 h-5"></p>
                </div>
            `;
            
             setTimeout(() => {
                const button = el.querySelector('#auth-button');
                const emailInput = el.querySelector('#email'); // Keep for potential future use, though readonly now
                const passwordInput = el.querySelector('#password');
                const errorMsg = el.querySelector('#error-message');

                button.addEventListener('click', async () => {
                    const email = ADMIN_EMAIL; // Hardcoded
                    const password = passwordInput.value;
                    errorMsg.textContent = ''; 

                    if (!password) {
                        errorMsg.textContent = "Please enter the password.";
                        return;
                    }

                    button.disabled = true;
                    button.textContent = "Signing In...";
                    errorMsg.textContent = ''; 

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // onAuthStateChanged handles success
                    } catch (error) {
                        let userFriendlyError = "Invalid password."; // Default
                         if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            userFriendlyError = "Invalid password.";
                         } else {
                             userFriendlyError = "Login failed. Please try again."; // General error
                         }
                        errorMsg.textContent = userFriendlyError;
                        console.error("Auth Error:", error); 
                        button.disabled = false; 
                        button.textContent = "Sign In";
                    } 
                });
                
                // Add focus to password field
                 passwordInput.focus();
                 // Allow Enter key submission from password field
                 passwordInput.addEventListener('keyup', (event) => {
                     if (event.key === 'Enter') {
                         button.click();
                     }
                 });


            }, 0);

            return el;
        }

        function Header({ title, onBack, rightContent }) {
             // ... (Header function remains the same) ...
             return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center w-full sticky top-0 z-20">
                    <div class="flex items-center">
                        ${onBack ? `<button onclick="handleBack()" class="p-2 mr-4 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>` : ''}
                        <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                    </div>
                    <div class="flex items-center space-x-2">${rightContent || ''}</div>
                </header>`;
        }
        
        function CoachListScreen() {
             // Admin check implied as only admin gets here now
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            const rightHeaderContent = `
                <button onclick="handleBackupData()" class="text-sm bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200">Backup Data</button>
                <button onclick="handleRestoreClick()" class="text-sm bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200">Restore Data</button>
                <button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>
            `;

            const filteredCoaches = Object.entries(state.coaches).filter(([id, coach]) => {
                const query = state.searchQuery.toLowerCase();
                const nameMatch = coach && coach.name && coach.name.toLowerCase().includes(query);
                const clubMatch = coach && coach.club && coach.club.toLowerCase().includes(query);
                // Email match removed as email is no longer stored on coach profile
                return nameMatch || clubMatch;
            });

            el.innerHTML = `
                ${Header({ title: "Rowing Coaches", rightContent: rightHeaderContent })} 
                <div class="mt-6 mb-4">
                    <input type="search" oninput="handleSearch(this.value)" value="${state.searchQuery}" placeholder="Search by name or club..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${filteredCoaches.map(([id, coach]) => `
                        <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow flex items-center justify-between space-x-4">
                           <div class="flex items-center space-x-4 cursor-pointer flex-grow" onclick="handleSelectCoach('${id}')">
                                <div class="bg-[#00a99d] rounded-full p-3 text-white flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${coach.name || 'Unnamed Coach'}</h3>
                                    <p class="text-sm text-gray-600">${coach.club || 'No club assigned'}</p>
                                    <p class="text-xs text-gray-400 mt-1">${(coach.sessions || []).length} session${(coach.sessions || []).length !== 1 ? 's' : ''} recorded</p>
                                </div>
                            </div>
                            <button onclick="handleDeleteCoach('${id}', '${coach.name || 'this coach'}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>`).join('')}
                    <button onclick="openCoachModal()" class="bg-gray-100 p-4 rounded-lg border-2 border-dashed border-gray-300 hover:border-[#00a99d] hover:bg-teal-50 transition-all flex flex-col items-center justify-center text-gray-500 hover:text-[#00a99d]">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="mt-2 font-semibold">Add New Coach</span> 
                    </button>
                </main>`;
            return el;
        }
        
        function CoachDetailScreen() {
             // ... (CoachDetailScreen structure remains mostly the same, ensureisAdmin checks removed where appropriate if only admin can reach) ...
             // ... Chart rendering logic needs the prop-types fix from previous step ...
             const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
             if (!state.selectedCoachId || !state.coaches[state.selectedCoachId]) {
                 el.innerHTML = `<p class="text-center text-red-600 mt-10">Error: Could not load coach data.</p> 
                                 <div class="text-center mt-4"><button onclick="setState({currentView: 'coachList', selectedCoachId: null})" class="bg-gray-200 p-2 rounded">Back to List</button></div>`;
                 return el;
             }
            const coach = state.coaches[state.selectedCoachId];

            // Only admin reaches here, simplify header buttons
            const headerButtons = `
                <button onclick="openCoachModal('${state.selectedCoachId}')" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit Coach
                </button>
                <button onclick="handleLogout()" class="ml-2 text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>`; 
            

            el.innerHTML = `
                ${Header({ title: coach.name || 'Coach Profile', onBack: 'handleBack()', rightContent: headerButtons })}
                <main class="mt-8">
                    <p class="text-lg font-semibold text-[#00a99d] -mt-4 mb-6">${coach.club || 'No Club Assigned'}</p>
                    
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Goals</h2>
                        <textarea id="coach-goals-textarea" class="w-full p-2 border border-gray-300 rounded-md h-32" placeholder="Enter the coach's long-term development goals...">${coach.goals || ''}</textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="handleSaveGoals()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors">Save Goals</button> 
                        </div>
                    </div>

                    <div id="chart-container" class="bg-white p-6 rounded-lg shadow mb-8">
                         <p class="text-gray-500">Loading chart...</p> 
                    </div> 
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Session History</h2>
                        <button onclick="handleNewSession()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                             New Session
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${(coach.sessions || []).length > 0 ? (coach.sessions || []).sort((a,b) => new Date(b.date) - new Date(a.date)).map(session => `
                            <div onclick='handleSelectSession(${JSON.stringify(session)})' class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer">
                                <p class="font-semibold text-gray-900">Session: ${new Date(session.date).toLocaleDateString('en-NZ', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-600 mt-1">Focus: ${session.focus || 'N/A'}</p>
                            </div>`).join('') : `<p class="text-gray-500 md:col-span-2">No sessions recorded yet.</p>`
                        }
                    </div>
                </main>`;

            // Render Chart - Retained robust logic including PropTypes check
            setTimeout(() => {
                const chartContainer = document.getElementById('chart-container');
                 if (!chartContainer) { console.error("Chart container not found."); return; } 

                 if ((coach.sessions || []).length > 0) {
                     let attempts = 0;
                     const maxAttempts = 10; 
                     const intervalTime = 500; 

                     const checkLibsAndRender = () => {
                         attempts++;
                         if (window.React && window.ReactDOM && window.PropTypes && window.Recharts && window.Recharts.BarChart) {
                             console.log("React, ReactDOM, PropTypes, and Recharts loaded successfully for chart.");
                             const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
                             
                             const chartData = (coach.sessions || []).map(session => {
                                const sessionData = { date: new Date(session.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) };
                                (session.feedback || []).forEach(fb => { sessionData[fb.category] = fb.score; });
                                return sessionData;
                             });
                             const categories = Object.keys(rubricData);
                             const colors = ['#00a99d', '#002d3c', '#ffc658', '#8884d8', '#ff8042', '#a4de6c']; 

                             try {
                                const chart = React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
                                    React.createElement(BarChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                                        React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                                        React.createElement(XAxis, { dataKey: "date" }),
                                        React.createElement(YAxis, { domain: [0, 5], allowDecimals: false }),
                                        React.createElement(Tooltip, null),
                                        React.createElement(Legend, null),
                                        ...categories.map((cat, index) => React.createElement(Bar, { key: cat, dataKey: cat, fill: colors[index % colors.length], name: cat.replace("Understands ","")}))
                                    )
                                );
                                chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Progress Over Time</h3>`; 
                                const chartRoot = document.createElement('div');
                                chartRoot.style.width = '100%';
                                chartRoot.style.height = '400px';
                                chartContainer.appendChild(chartRoot);
                                ReactDOM.render(chart, chartRoot);
                            } catch (renderError) {
                                 console.error("Error rendering React chart:", renderError);
                                 chartContainer.innerHTML = '<p class="text-red-500">Error: Could not render the chart.</p>';
                            }

                        } else if (attempts >= maxAttempts) {
                            let errorMsg = "Chart library (Recharts)";
                            if (!window.React) errorMsg = "React library";
                            else if (!window.ReactDOM) errorMsg = "ReactDOM library";
                            else if (!window.PropTypes) errorMsg = "PropTypes library"; 
                            
                            console.error(`${errorMsg} failed to load after ${maxAttempts * intervalTime / 1000} seconds.`);
                            chartContainer.innerHTML = `<p class="text-red-500">Error: ${errorMsg} failed to load. Please check network or console.</p>`;
                        } else {
                             let waitingFor = "Recharts";
                             if (!window.React) waitingFor = "React";
                             else if (!window.ReactDOM) waitingFor = "ReactDOM";
                             else if (!window.PropTypes) waitingFor = "PropTypes"; 
                             console.log(`${waitingFor} not ready, attempt ${attempts}. Retrying in ${intervalTime}ms...`);
                            setTimeout(checkLibsAndRender, intervalTime);
                        }
                    };
                    checkLibsAndRender();

                } else if (chartContainer) {
                    console.log("No sessions found for coach, hiding chart container.");
                     chartContainer.innerHTML = ''; 
                    chartContainer.style.display = 'none';
                }
            }, 100); 
            return el;
        }

        function SessionFeedbackScreen() {
             // ... (SessionFeedbackScreen remains the same) ...
             const el = document.createElement('div');
             el.className = 'p-4 md:p-8';
             const coach = state.coaches[state.selectedCoachId];
             if (!coach) {
                 el.innerHTML = `<p class="text-red-600">Error: Cannot load session, coach not found.</p>`;
                 return el;
             }
             let session = state.selectedSession ? JSON.parse(JSON.stringify(state.selectedSession)) : {
                id: `session-${Date.now()}-${Math.random().toString(16).slice(2)}`, 
                date: new Date().toISOString().split('T')[0], 
                focus: '',
                feedback: Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' })),
                summary: '', 
                actionPlan: '', 
                athleteFeedback: ''
             };
             if (!session.feedback || session.feedback.length !== Object.keys(rubricData).length) {
                session.feedback = Object.keys(rubricData).map(cat => {
                    const existing = (session.feedback || []).find(f => f.category === cat);
                    return existing || { category: cat, score: null, comments: '' };
                });
             }
             
             el.innerHTML = `
                ${Header({ title: `${state.selectedSession ? 'Edit' : 'New'} Session for ${coach.name}`, onBack: 'handleBack()' })}
                <main id="session-form" class="mt-8">
                    <!-- form content will be injected here -->
                </main>
             `;

             setTimeout(() => {
                const formContainer = document.getElementById('session-form');
                if(!formContainer) return;
                
                const athleteFeedbackButtonHTML = session.athleteFeedback 
                    ? `<button onclick="handleGetAthleteFeedback()" class="bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        View Athlete Feedback
                       </button>`
                    : `<button onclick="handleGetAthleteFeedback()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Get Athlete Feedback</button>`;

                const feedbackHTML = session.feedback ? Object.entries(rubricData).map(([category, data]) => {
                        const currentFeedback = session.feedback.find(f => f.category === category) || { score: null, comments: "" };
                        return `
                        <div class="bg-white p-6 rounded-lg shadow mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">${category}</h3>
                            <p class="text-sm text-gray-500">${data.description}</p>
                            <div class="mt-6">
                               <div class="flex justify-between text-xs text-gray-600 px-1 mb-4">
                                ${[...Array(6)].map((_, i) => `<button data-cat="${category}" data-score="${i}" class="score-btn w-10 h-10 flex items-center justify-center rounded-full transition-colors ${currentFeedback.score === i ? 'bg-[#00a99d] text-white font-bold' : 'bg-gray-200 hover:bg-teal-100'}">${i}</button>`).join('')}
                               </div>
                               <p class="text-gray-700 mb-4 h-12"><strong>Description: </strong><span id="desc-${category.replace(/\s+/g, '')}">${currentFeedback.score !== null && currentFeedback.score > -1 ? data.levels[currentFeedback.score] : "Select a rating."}</span></p>
                               <textarea name="comments" data-cat="${category}" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Add specific examples...">${currentFeedback.comments || ''}</textarea>
                            </div>
                        </div>`
                    }).join('') : '<p class="text-red-500">Error: Could not load feedback categories.</p>';

                const formHTML = `
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <label for="date" class="font-medium text-gray-700 block mb-2">Session Date:</label>
                                <input type="date" name="date" value="${session.date}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                            <div>
                                <label for="focus" class="font-medium text-gray-700 block mb-2">Session Focus:</label>
                                <input type="text" name="focus" value="${session.focus || ''}" placeholder="e.g., Technical drills, race prep" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                            <div class="md:col-span-2">
                                ${athleteFeedbackButtonHTML}
                            </div>
                        </div>
                    </div>
                    ${feedbackHTML}
                     <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Session Summary</h3>
                        <div>
                            <label for="summary" class="font-medium text-gray-700 block mb-2">Key Takeaways:</label>
                            <textarea name="summary" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.summary || ''}</textarea>
                         </div>
                         <div class="mt-4">
                            <label for="actionPlan" class="font-medium text-gray-700 block mb-2">Action Plan / Next Steps:</label>
                            <textarea name="actionPlan" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.actionPlan || ''}</textarea>
                         </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="save-btn" class="bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69]">Save Session Feedback</button>
                    </div>`;

                formContainer.innerHTML = formHTML;

                formContainer.querySelectorAll('.score-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.dataset.cat;
                        const score = parseInt(btn.dataset.score);
                         if (!session.feedback) session.feedback = []; 
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        if(fbIndex === -1) { 
                             session.feedback.push({ category: category, score: score, comments: '' });
                             const newFbIndex = session.feedback.findIndex(f => f.category === category);
                             if (newFbIndex === -1) return; 
                             session.feedback[newFbIndex].score = score;
                         } else {
                             session.feedback[fbIndex].score = score;
                         }
                        
                        document.getElementById(`desc-${category.replace(/\s+/g, '')}`).textContent = rubricData[category].levels[score];
                        formContainer.querySelectorAll(`.score-btn[data-cat="${category}"]`).forEach(b => {
                            b.classList.toggle('bg-[#00a99d]', parseInt(b.dataset.score) === score);
                            b.classList.toggle('text-white', parseInt(b.dataset.score) === score);
                            b.classList.toggle('font-bold', parseInt(b.dataset.score) === score);
                            b.classList.toggle('bg-gray-200', parseInt(b.dataset.score) !== score);
                        });
                    });
                });

                document.getElementById('save-btn').addEventListener('click', () => {
                    session.date = formContainer.querySelector('input[name="date"]').value;
                    session.focus = formContainer.querySelector('input[name="focus"]').value;
                    session.summary = formContainer.querySelector('textarea[name="summary"]').value;
                    session.actionPlan = formContainer.querySelector('textarea[name="actionPlan"]').value;
                    
                     if (!session.feedback) session.feedback = Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' }));

                    formContainer.querySelectorAll('textarea[name="comments"]').forEach(textarea => {
                        const category = textarea.dataset.cat;
                         const fbIndex = session.feedback.findIndex(f => f.category === category);
                         if (fbIndex > -1) { 
                             session.feedback[fbIndex].comments = textarea.value;
                         } else {
                             session.feedback.push({ category: category, score: null, comments: textarea.value });
                         }
                    });
                     session.athleteFeedback = state.selectedSession?.athleteFeedback || session.athleteFeedback || ''; 
                    handleSaveSession(session);
                });

             }, 0);

             return el;
        }

        function AthleteFeedbackScreen() {
             // ... (AthleteFeedbackScreen remains the same) ...
             const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
             if (!state.selectedCoachId || !state.coaches[state.selectedCoachId] || !state.selectedSession) {
                 el.innerHTML = `<p class="text-red-600">Error: Cannot load feedback screen, missing data.</p>`;
                 return el;
             }
            const coach = state.coaches[state.selectedCoachId];
            const session = state.selectedSession;

            el.innerHTML = `
                ${Header({ title: `Athlete Feedback`, onBack: 'handleBack()' })}
                <main class="mt-8 max-w-4xl mx-auto">
                     <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h2 class="text-2xl font-bold text-gray-800">Feedback for ${coach.name}</h2>
                        <p class="text-gray-600 mt-1">Session on ${new Date(session.date).toLocaleDateString('en-NZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="text-gray-600">Focus: ${session.focus || 'N/A'}</p>
                        
                        <div class="mt-6 text-left">
                            <label for="athlete-feedback-textarea" class="font-medium text-gray-700 block mb-2">Your Feedback:</label>
                            <textarea id="athlete-feedback-textarea" class="w-full p-2 border border-gray-300 rounded-md h-48" placeholder="Please provide your honest feedback about the session...">${session.athleteFeedback || ''}</textarea>
                        </div>

                        <div class="mt-6">
                            <button onclick="handleSaveAthleteFeedback()" class="bg-[#002d3c] text-white font-bold py-3 px-8 rounded-lg hover:bg-[#004e69] transition-colors text-lg">
                                Save and Finish
                            </button>
                        </div>
                     </div>
                </main>
            `;
            return el;
        }
        
        function CoachNotFoundScreen() {
            // ... (CoachNotFoundScreen remains the same) ...
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8 flex flex-col items-center justify-center h-screen text-center';
            const logoutButton = `<button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mt-6">Logout</button>`;
             el.innerHTML = `
                <img src="bop-logo.png" alt="Bay of Plenty Rowing Logo" class="w-48 mx-auto mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Profile Not Ready</h1>
                <p class="text-gray-600">Your coach profile has not been created by the administrator yet.</p>
                <p class="text-gray-600">Please contact ${ADMIN_EMAIL} to have your profile set up before you can use the app.</p>
                ${logoutButton}
             `;
             return el;
        }


        // --- INITIALIZATION & DATA LOADING ---
        let unsubscribe; // Firestore listener

        async function loadDataForUser(user) { // Simplified back to only load all coaches
            if (!user || !user.uid || user.email !== ADMIN_EMAIL) {
                 console.log("loadDataForUser: Aborting, not admin user.");
                 if (state.authReady) { 
                    setState({ loading: false, user: null }); // Ensure logout state if not admin
                 }
                 return;
             }
            
            console.log("loadDataForUser: Loading data for admin user", user.email);
            setState({ loading: true, loadingMessage: "Loading coach data..." }); 
            
            const dataQuery = query(collection(db, 'coaches')); // Fetch all

            if (unsubscribe) {
                 console.log("Unsubscribing from previous listener.");
                 unsubscribe();
                 unsubscribe = null;
             }

            console.log("Setting up Firestore listener for all coaches...");
            unsubscribe = onSnapshot(dataQuery, (querySnapshot) => {
                console.log(`Firestore snapshot received. Size: ${querySnapshot.size}`);
                const coachesData = {};
                querySnapshot.forEach((doc) => {
                    coachesData[doc.id] = { id: doc.id, ...doc.data() };
                });

                setState({ 
                    coaches: coachesData,
                    loading: false // Data loaded
                 }); 

            }, (error) => {
                console.error("Firestore onSnapshot Error: ", error);
                alert("Could not load coach data. Check console or Firestore Rules. Logging out.");
                handleLogout(); 
            });
        }

        // --- MODAL & BACKUP/RESTORE HANDLING ---
         window.openCoachModal = (coachId = null) => { // Make global
            const modal = document.getElementById('coach-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('coach-name-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');

            clubSelect.innerHTML = clubs.map(club => `<option value="${club}">${club}</option>`).join('');

            if (coachId) {
                const coach = state.coaches[coachId];
                 if (!coach) { console.error("Cannot open edit modal, coach not found:", coachId); return; }
                title.textContent = 'Edit Coach'; // Simplified title
                nameInput.value = coach.name || '';
                clubSelect.value = coach.club || clubs[0]; 
                coachIdInput.value = coachId;
            } else {
                title.textContent = 'Add New Coach'; // Simplified title
                nameInput.value = '';
                clubSelect.value = clubs[0];
                coachIdInput.value = '';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeCoachModal = () => { // Make global
            const modal = document.getElementById('coach-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        async function saveCoach() {
            const nameInput = document.getElementById('coach-name-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');
            
            const name = nameInput.value.trim();
            const club = clubSelect.value;
            const coachId = coachIdInput.value;

            if (!name) { alert("Please enter the coach's name."); return; }
            if (!state.user || !state.user.uid) { alert("Not signed in."); return; } // Check user exists

            const saveButton = document.getElementById('save-coach-button');
            saveButton.disabled = true;
            saveButton.textContent = "Saving...";

            try {
                if (coachId) { // Editing
                    const coachRef = doc(db, 'coaches', coachId);
                    await updateDoc(coachRef, { name, club });
                     alert('Coach updated.');
                } else { // Adding
                    // Use admin's UID for the userId field
                    await addDoc(collection(db, 'coaches'), {
                        name, club,
                        sessions: [], goals: '', 
                        userId: state.user.uid // Use admin's UID
                    });
                     alert('Coach added.');
                }
                closeCoachModal();
            } catch (error) {
                console.error("Error saving coach: ", error);
                alert("Failed to save coach.");
            } finally {
                 saveButton.disabled = false;
                 saveButton.textContent = "Save Coach";
            }
        }
        
        async function handleFileSelected(event) { 
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("ADMIN ACTION: Restore will overwrite ALL current data. Continue?")) {
                event.target.value = null; return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    if (typeof restoredData !== 'object' || restoredData === null) {
                        throw new Error("Invalid backup format.");
                    }

                    setState({ loading: true, loadingMessage: "Restoring data..." });

                    const currentCoachesSnapshot = await getDocs(collection(db, 'coaches'));
                    const deletePromises = currentCoachesSnapshot.docs.map(d => deleteDoc(d.ref));
                    await Promise.all(deletePromises);
                    console.log("Existing coaches deleted.");

                    const addPromises = Object.entries(restoredData).map(([coachId, coachData]) => {
                        // Ensure essential fields and use logged-in admin's UID
                        const dataToSave = { 
                            name: coachData.name || "Unnamed Coach",
                            club: coachData.club || null,
                            sessions: coachData.sessions || [],
                            goals: coachData.goals || '', 
                            userId: state.user.uid // Force current admin UID
                         };
                        console.log("Restoring coach:", coachId);
                        return setDoc(doc(db, 'coaches', coachId), dataToSave); 
                    });
                    await Promise.all(addPromises);

                    alert("Restore successful!");
                    console.log("Restore complete.");

                } catch (error) {
                    console.error("Restore failed:", error);
                    alert(`Restore failed: ${error.message}`);
                } finally {
                     if (state.user) { loadDataForUser(state.user); } 
                     else { setState({ loading: false }); }
                    event.target.value = null; 
                }
            };
            reader.onerror = () => { alert('Failed to read file.'); event.target.value = null; };
            reader.readAsText(file);
        }


        // --- APP STARTUP ---
        let authReady = false; 
        console.log("Setting up Auth State Listener...");
        onAuthStateChanged(auth, (currentUser) => {
            console.log("Auth State Changed. User:", currentUser ? currentUser.email : "null", "Auth Ready:", authReady);
            
            const wasAuthReady = authReady; 
             if (!authReady) {
                console.log("Initial auth check complete.");
                authReady = true; 
                 // Set authReady, determine initial loading state based on currentUser
                 setState({ authReady: true, loading: !!currentUser, loadingMessage: currentUser ? "Authenticating..." : "" }); 
            }

            const newUserId = currentUser ? currentUser.uid : null;

            // Only react if user ID changes OR it's the first time auth is ready
            if (newUserId !== currentUserId || !wasAuthReady) {
                console.log("User change or initial auth. Prev ID:", currentUserId, "New ID:", newUserId);
                currentUserId = newUserId; 

                if (currentUser && currentUser.email === ADMIN_EMAIL) {
                    // Correct admin user signed in
                     console.log("Admin user detected.");
                     setState({ user: currentUser, loadingMessage: "Loading coach data..." }); // Keep loading true
                     loadDataForUser(currentUser); // Load data, will set loading=false
                } else {
                     // Not the admin user OR signed out
                     if (currentUser) {
                         console.warn("Non-admin user logged in, logging out.");
                         signOut(auth); // Force logout if not admin
                     } else {
                         console.log("User signed out or is not admin. Resetting state.");
                     }
                    
                    if (unsubscribe) {
                         console.log("Unsubscribing from listener.");
                         unsubscribe(); 
                         unsubscribe = null;
                    }
                    // Reset state and show login screen
                    setState({ 
                        user: null, 
                        authReady: true, 
                        loading: false, // Stop loading
                        coaches: {}, 
                        currentView: 'coachList', 
                        selectedCoachId: null, selectedSession: null, searchQuery: ''
                     });
                }
            } else {
                 console.log("Auth state change for same user (token refresh?). No major state update.");
                 // If auth is ready and not loading, just re-render in case
                 if (state.authReady && !state.loading) { 
                      renderApp(); 
                 }
            }
        });


        // Attach modal and file input event listeners after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Attaching listeners.");
            const saveBtn = document.getElementById('save-coach-button');
            const cancelBtn = document.getElementById('cancel-coach-modal');
            const restoreInput = document.getElementById('restore-input');
            
            window.openCoachModal = openCoachModal;
            window.closeCoachModal = closeCoachModal;
            
            if (saveBtn) saveBtn.addEventListener('click', saveCoach); 
            else console.error("Save coach button not found");

            if(cancelBtn) cancelBtn.addEventListener('click', closeCoachModal);
            else console.error("Cancel coach modal button not found");

            if(restoreInput) restoreInput.addEventListener('change', handleFileSelected);
            else console.error("Restore file input not found");
        });

    </script>
</body>
</html>
