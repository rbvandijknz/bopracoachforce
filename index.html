<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOP Rowing Coach Development</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .login-card {
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"><div class="flex justify-center items-center h-screen bg-gray-50"><p class="text-lg text-gray-700">Initializing Application...</p></div></div>

    <!-- Add/Edit Coach Modal -->
    <div id="coach-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add New Coach</h2>
            <input type="hidden" id="coach-id-input">
            <div class="space-y-4">
                <div>
                    <label for="coach-name-input" class="block text-sm font-medium text-gray-700">Coach Name</label>
                    <input type="text" id="coach-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                 <div>
                    <label for="coach-email-input" class="block text-sm font-medium text-gray-700">Coach Login Email</label>
                    <input type="email" id="coach-email-input" placeholder="coach.email@example.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                <div>
                    <label for="coach-club-select" class="block text-sm font-medium text-gray-700">Club</label>
                    <select id="coach-club-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-coach-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-coach-button" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69]">Save Coach</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="restore-input" class="hidden" accept=".json">


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, query, where, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- CONSTANTS ---
        const ADMIN_EMAIL = 'merowing@xtra.co.nz';
        const firebaseConfig = {
            apiKey: "AIzaSyAVbGWN3LclrUZMtv-L7x0D8HF7OQ3viK8",
            authDomain: "bopracoachfeedback.firebaseapp.com",
            projectId: "bopracoachfeedback",
            storageBucket: "bopracoachfeedback.appspot.com",
            messagingSenderId: "967552327697",
            appId: "1:967552327697:web:f3a2e3ffa5d6c6a3f611b0",
            measurementId: "G-NRQ2HSJGT6"
        };
        const rubricData = {
          "Understands the Sport": { description: "(technical, tactical, rules)", levels: ["Open to learning sport-specific knowledge.", "Starting to notice techniques and rules in action.", "Beginning to apply knowledge of techniques and rules with athletes.", "Using sport knowledge intentionally with athletes.", "Adapting technical/tactical elements confidently.", "Mentoring and sharing sport knowledge with others."] },
          "Understands Self": { description: "(leadership, philosophy, self-awareness, communication)", levels: ["Becoming aware of the coaching role and its impact.", "Noticing different coaching styles and effects.", "Starting to reflect on personal coaching style and values.", "Established a coaching philosophy and starting to implement.", "Adapting communication and coaching style to suit others' needs.", "Supporting others through clear, authentic leadership."] },
          "Understands Environment": { description: "(culture, learning space)", levels: ["Beginning to consider how environment affects learning.", "Noticing group dynamics and inclusion opportunities.", "Trying new strategies to include and engage all athletes.", "Creating space that supports trust and growth.", "Shaping a positive culture through deliberate actions.", "Supporting athletes in co-creating a positive environment."] },
          "Understands Learning": { description: "(reflection, planning, pedagogy/andragogy)", levels: ["Starting to think about how people learn.", "Noticing different learning preferences and athlete needs.", "Planning sessions with learning styles and athlete needs in mind (Athlete-centred).", "Adapting activities based on reflection and feedback.", "Applying learning theory with confidence.", "Designing learning based on individual needs and goals."] },
          "Understands Development": { description: "(age & stage, feedback, development)", levels: ["Building awareness of how athletes develop.", "Reflecting on sessions relative to age and stage.", "Planning sessions with the development needs of age and stage in mind.", "Providing purposeful feedback and clear expectations relative to age and stage.", "Balancing support with challenge in meaningful ways.", "Transforming performance through reflective support."] }
        };
        const levelNames = ["Emerging", "Exploring", "Developing", "Applying", "Integrating", "Leading"];
        const clubs = ["Bay of Plenty Coast", "Rotorua", "Taupo", "Tauranga", "Whakatane", "Tauranga Boys' College"];
        
        let app;
        let db;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Initialized Successfully");
        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600">Failed to initialize Firebase. Check console for details.</div>`;
            // Stop further execution if Firebase fails to initialize
            throw new Error("Firebase init failed"); 
        }

        // --- APPLICATION STATE ---
        let state = {
            loading: true, // Start in loading state
            loadingMessage: "Initializing Application...",
            user: null, // This will be the firebase user object or null
            isAdmin: false,
            coaches: {}, // For admin: all coaches; For coach: their own profile document { id: data }
            currentView: 'coachList', // Default view if logged in
            selectedCoachId: null, // Only relevant for admin view or coach viewing their own
            selectedSession: null,
            searchQuery: '',
            coachProfileNotFound: false, // Flag for coaches whose profile isn't created yet
        };
        
        const root = document.getElementById('app');

        // --- STATE MANAGEMENT & RENDERING ---
        function setState(newState) {
            console.log("Setting State:", newState); // Log state changes
            state = { ...state, ...newState };
            renderApp();
        }

        function renderApp() {
            root.innerHTML = ''; // Clear the screen
            
            if (state.loading) {
                 root.innerHTML = `<div class="flex justify-center items-center h-screen bg-gray-50"><p class="text-lg text-gray-700">${state.loadingMessage}</p></div>`;
                 return;
            }
            
            if (!state.user) {
                root.appendChild(LoginScreen());
                return;
            }

            if (state.coachProfileNotFound && !state.isAdmin) {
                root.appendChild(CoachNotFoundScreen());
                return;
            }

            // Coach user bypasses list view and goes straight to their details
            if (!state.isAdmin && state.currentView === 'coachList' && Object.keys(state.coaches).length === 1) {
                 console.log("Coach detected, redirecting to detail view");
                 state.selectedCoachId = Object.keys(state.coaches)[0]; // Set their own ID
                 state.currentView = 'coachDetail'; // Force detail view
                 // Needs direct call to render the correct view immediately
                 root.appendChild(CoachDetailScreen()); 
                 return; 
            }

            switch(state.currentView) {
                case 'coachDetail':
                    root.appendChild(CoachDetailScreen());
                    break;
                case 'sessionFeedback':
                    root.appendChild(SessionFeedbackScreen());
                    break;
                case 'athleteFeedback':
                    root.appendChild(AthleteFeedbackScreen());
                    break;
                case 'coachList':
                    if (state.isAdmin) {
                         root.appendChild(CoachListScreen());
                    } else {
                        // Redirect logged in coach without profile to not found screen
                        if (Object.keys(state.coaches).length === 0) {
                             root.appendChild(CoachNotFoundScreen());
                        } else {
                             // Should have already been redirected to coachDetail, but as fallback:
                             root.appendChild(CoachDetailScreen()); 
                        }
                    }
                    break;
                default:
                     if (state.isAdmin) {
                         root.appendChild(CoachListScreen());
                    } else {
                        if (Object.keys(state.coaches).length === 0) {
                             root.appendChild(CoachNotFoundScreen());
                        } else {
                             root.appendChild(CoachDetailScreen()); 
                        }
                    }
                    break;
            }
        }
        
        // --- DATA HANDLING & NAVIGATION ---
        window.handleSelectCoach = (coachId) => setState({ selectedCoachId: coachId, currentView: 'coachDetail' });
        window.handleSelectSession = (session) => setState({ selectedSession: session, currentView: 'sessionFeedback' });
        window.handleNewSession = () => setState({ selectedSession: null, currentView: 'sessionFeedback' });
        window.handleBack = () => {
            if (state.currentView === 'sessionFeedback') setState({ currentView: 'coachDetail' });
            else if (state.currentView === 'athleteFeedback') setState({ currentView: 'sessionFeedback' });
            else if (state.currentView === 'coachDetail') {
                 if (state.isAdmin) {
                    setState({ currentView: 'coachList', selectedCoachId: null });
                 } else {
                     // Coaches can't go 'back' from their detail view.
                 }
            }
        };
       
        window.handleSaveSession = async (sessionData) => {
            if (!state.selectedCoachId) {
                console.error("Cannot save session, no coach selected.");
                alert("Error: No coach is selected.");
                return;
            }
            const coachRef = doc(db, 'coaches', state.selectedCoachId);
            // Ensure we are working with the latest coach data from state
            const coachToUpdate = state.coaches[state.selectedCoachId]; 
            if (!coachToUpdate) {
                console.error("Cannot save session, coach data not found in state for ID:", state.selectedCoachId);
                alert("Error: Could not find coach data to update.");
                return;
            }

            const sessionIndex = (coachToUpdate.sessions || []).findIndex(s => s.id === sessionData.id);
            let updatedSessions;

            if (sessionIndex > -1) {
                updatedSessions = coachToUpdate.sessions.map(s => s.id === sessionData.id ? sessionData : s);
            } else {
                updatedSessions = [...(coachToUpdate.sessions || []), sessionData];
            }
            
            try {
                await updateDoc(coachRef, { sessions: updatedSessions });
                console.log("Session saved successfully to Firestore.");

                // Update local state directly AFTER successful save
                const updatedCoaches = { 
                    ...state.coaches, 
                    [state.selectedCoachId]: { ...coachToUpdate, sessions: updatedSessions } 
                };
                
                setState({ 
                    coaches: updatedCoaches, 
                    selectedSession: sessionData, // Keep updated session data
                    currentView: 'coachDetail' // Navigate back
                });

            } catch (error) {
                console.error("Error saving session to Firestore: ", error);
                alert("Failed to save session feedback. Please check permissions or network.");
            }
        };
        
        window.handleDeleteCoach = async (coachId, coachName) => {
             if (!state.isAdmin) return; 
             if (confirm(`Are you sure you want to delete ${coachName}? This action cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, 'coaches', coachId));
                    console.log(`Coach ${coachName} deleted.`);
                    // onSnapshot will handle UI update
                } catch (error) {
                    console.error("Error deleting coach:", error);
                    alert("Failed to delete coach. Please try again.");
                }
            }
        };

        window.handleLogout = async () => {
            console.log("Logging out...");
            // Reset state immediately for faster UI feedback
             setState({ user: null, isAdmin: false, coaches: {}, coachProfileNotFound: false, currentView: 'coachList', loading: false, selectedCoachId: null, selectedSession: null, searchQuery: '' }); 
            try {
                await signOut(auth);
                console.log("Sign out successful.");
                if (unsubscribe) {
                    console.log("Unsubscribing from Firestore listener.");
                    unsubscribe(); 
                    unsubscribe = null;
                }
            } catch(error) {
                console.error("Error signing out:", error);
            }
        };
        
        window.handleSaveGoals = async () => {
             if (!state.isAdmin) return; // Only admin saves goals
            const goalsTextarea = document.getElementById('coach-goals-textarea');
            if (!goalsTextarea || !state.selectedCoachId) return;

            const newGoals = goalsTextarea.value;
            const coachRef = doc(db, 'coaches', state.selectedCoachId);

            try {
                await updateDoc(coachRef, { goals: newGoals });
                // Update local state directly after successful save
                 const updatedCoach = { ...state.coaches[state.selectedCoachId], goals: newGoals };
                 const updatedCoaches = { ...state.coaches, [state.selectedCoachId]: updatedCoach };
                 setState({ coaches: updatedCoaches }); // Update state to reflect change
                alert('Goals saved successfully!');
            } catch (error) {
                console.error("Error saving goals:", error);
                alert("Failed to save goals. Please try again.");
            }
        };

        window.handleGetAthleteFeedback = () => {
            setState({ currentView: 'athleteFeedback' });
        };

        window.handleSaveAthleteFeedback = async () => {
            const feedbackText = document.getElementById('athlete-feedback-textarea').value;
            // Get a fresh copy of the session from state to avoid stale data issues
            let currentSession = state.selectedSession ? JSON.parse(JSON.stringify(state.selectedSession)) : null; 
            if (!currentSession) {
                 console.error("Cannot save athlete feedback, no session selected in state.");
                 alert("Error: No session is currently selected.");
                 setState({ currentView: 'coachDetail' }); // Go back safely
                 return;
            }
            currentSession.athleteFeedback = feedbackText;

            // Save the entire session object back
            await handleSaveSession(currentSession); 
            // handleSaveSession now navigates back to coachDetail
            // We need to ensure the local selectedSession is also updated if needed later
            // setState({ selectedSession: currentSession }); // Update selected session locally AFTER save if needed
        };
        
        window.handleSearch = (query) => {
            setState({ searchQuery: query });
        };


        // --- "COMPONENTS" (DOM element factories) ---
        function LoginScreen() {
            const el = document.createElement('div');
            el.className = 'flex flex-col justify-center items-center h-screen bg-gray-100 p-4';
            el.innerHTML = `
                <div class="login-card bg-white p-8 rounded-xl shadow-lg text-center">
                    <img src="bop-logo.png" alt="Bay of Plenty Rowing Logo" class="w-48 mx-auto mb-6">
                    <h1 id="auth-title" class="text-2xl font-bold text-gray-800 mb-2">Login</h1>
                    <p class="text-gray-600 mb-6">Enter your credentials to access the coach development app.</p>
                    <div class="space-y-4 text-left">
                        <div>
                           <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                           <input id="email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        </div>
                        <div>
                           <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                           <input id="password" type="password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        </div>
                    </div>
                    <button id="auth-button" class="mt-6 w-full bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69] transition-colors text-lg">
                        Sign In
                    </button>
                    <p id="error-message" class="text-red-500 mt-4 h-5"></p>
                    <p class="mt-4 text-sm">
                        <a href="#" id="auth-toggle" class="font-medium text-[#00a99d] hover:text-[#002d3c]">Need an account? Sign Up</a>
                    </p>
                </div>
            `;
            
             setTimeout(() => {
                const title = el.querySelector('#auth-title');
                const button = el.querySelector('#auth-button');
                const toggle = el.querySelector('#auth-toggle');
                const emailInput = el.querySelector('#email');
                const passwordInput = el.querySelector('#password');
                const errorMsg = el.querySelector('#error-message');
                let isLogin = true;

                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    isLogin = !isLogin;
                    title.textContent = isLogin ? 'Login' : 'Sign Up';
                    button.textContent = isLogin ? 'Sign In' : 'Create Account';
                    toggle.innerHTML = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Sign In';
                    errorMsg.textContent = '';
                });

                button.addEventListener('click', async () => {
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    errorMsg.textContent = '';

                    // Basic validation
                    if (!email || !password) {
                        errorMsg.textContent = "Please enter both email and password.";
                        return;
                    }
                    if (password.length < 6 && !isLogin) { // Password length check only for sign up
                        errorMsg.textContent = "Password must be at least 6 characters.";
                        return;
                    }


                    try {
                        setState({ loading: true, loadingMessage: isLogin ? "Signing In..." : "Creating Account..." }); 
                        if (isLogin) {
                            await signInWithEmailAndPassword(auth, email, password);
                            // onAuthStateChanged will handle successful login & profile check
                        } else {
                             if (email.toLowerCase() === ADMIN_EMAIL) {
                                 throw new Error("Cannot sign up with admin email address.");
                             }
                             await createUserWithEmailAndPassword(auth, email, password);
                             // User is automatically signed in. onAuthStateChanged handles profile check.
                        }
                    } catch (error) {
                         let userFriendlyError = error.message.replace('Firebase: ','');
                         if (error.code === 'auth/email-already-in-use') {
                             userFriendlyError = "An account with this email already exists. Try signing in instead.";
                         } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            userFriendlyError = "Invalid email or password.";
                         } else if (error.code === 'auth/invalid-email') {
                            userFriendlyError = "Please enter a valid email address.";
                         }
                        errorMsg.textContent = userFriendlyError;
                        console.error("Auth Error:", error); 
                        setState({ loading: false }); // Hide loading on error
                    } 
                    // No finally block: onAuthStateChanged handles success and sets loading false
                });

            }, 0);

            return el;
        }

        function Header({ title, onBack, rightContent }) {
            return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center w-full sticky top-0 z-20">
                    <div class="flex items-center">
                        ${onBack ? `<button onclick="${onBack}" class="p-2 mr-4 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>` : ''}
                        <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                    </div>
                    <div class="flex items-center space-x-2">${rightContent || ''}</div>
                </header>`;
        }
        
        function CoachListScreen() {
            if (!state.isAdmin) return document.createElement('div'); // Safety check

            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            const rightHeaderContent = `
                <button onclick="handleBackupData()" class="text-sm bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200">Backup Data</button>
                <button onclick="handleRestoreClick()" class="text-sm bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200">Restore Data</button>
                <button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>
            `;

            const filteredCoaches = Object.entries(state.coaches).filter(([id, coach]) => {
                const query = state.searchQuery.toLowerCase();
                const nameMatch = coach && coach.name && coach.name.toLowerCase().includes(query);
                const clubMatch = coach && coach.club && coach.club.toLowerCase().includes(query);
                const emailMatch = coach && coach.email && coach.email.toLowerCase().includes(query);
                return nameMatch || clubMatch || emailMatch;
            });

            el.innerHTML = `
                ${Header({ title: "Rowing Coaches (Admin)", rightContent: rightHeaderContent })}
                <div class="mt-6 mb-4">
                    <input type="search" oninput="handleSearch(this.value)" value="${state.searchQuery}" placeholder="Search by name, email or club..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${filteredCoaches.map(([id, coach]) => `
                        <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow flex items-center justify-between space-x-4">
                           <div class="flex items-center space-x-4 cursor-pointer flex-grow" onclick="handleSelectCoach('${id}')">
                                <div class="bg-[#00a99d] rounded-full p-3 text-white flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${coach.name || 'Unnamed Coach'}</h3>
                                    <p class="text-sm text-gray-600">${coach.club || 'No club assigned'}</p>
                                    <p class="text-xs text-gray-500">${coach.email || 'No email assigned'}</p>
                                    <p class="text-xs text-gray-400 mt-1">${(coach.sessions || []).length} session${(coach.sessions || []).length !== 1 ? 's' : ''} recorded</p>
                                </div>
                            </div>
                            <button onclick="handleDeleteCoach('${id}', '${coach.name || 'this coach'}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>`).join('')}
                    <button onclick="openCoachModal()" class="bg-gray-100 p-4 rounded-lg border-2 border-dashed border-gray-300 hover:border-[#00a99d] hover:bg-teal-50 transition-all flex flex-col items-center justify-center text-gray-500 hover:text-[#00a99d]">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="mt-2 font-semibold">Add New Coach Profile</span>
                    </button>
                </main>`;
            return el;
        }
        
        function CoachDetailScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
             if (!state.selectedCoachId || !state.coaches[state.selectedCoachId]) {
                 el.innerHTML = `<p class="text-center text-red-600 mt-10">Error: Could not load coach data.</p>`;
                 if (state.isAdmin) {
                     el.innerHTML += `<div class="text-center mt-4"><button onclick="setState({currentView: 'coachList', selectedCoachId: null})" class="bg-gray-200 p-2 rounded">Back to List</button></div>`;
                 } else {
                     el.innerHTML += `<div class="text-center mt-4"><button onclick="handleLogout()" class="bg-gray-200 p-2 rounded">Logout</button></div>`;
                 }
                 return el;
             }
            const coach = state.coaches[state.selectedCoachId];

            let headerButtons = '';
            if (state.isAdmin) {
                headerButtons = `<button onclick="openCoachModal('${state.selectedCoachId}')" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit Profile
                </button>`;
                 headerButtons += `<button onclick="handleLogout()" class="ml-2 text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>`; 
            } else {
                 headerButtons = `<button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>`;
            }

            el.innerHTML = `
                ${Header({ title: coach.name || 'Coach Profile', onBack: state.isAdmin ? 'handleBack()' : null, rightContent: headerButtons })}
                <main class="mt-8">
                    <p class="text-lg font-semibold text-[#00a99d] -mt-4 mb-6">${coach.club || 'No Club Assigned'}</p>
                    
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Goals</h2>
                        <textarea id="coach-goals-textarea" ${state.isAdmin ? '' : 'readonly'} class="w-full p-2 border border-gray-300 rounded-md h-32 ${state.isAdmin ? '' : 'bg-gray-100'}" placeholder="${state.isAdmin ? "Enter the coach's long-term development goals..." : "Goals set by admin"}">${coach.goals || ''}</textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="handleSaveGoals()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors ${state.isAdmin ? '' : 'hidden'}">Save Goals</button> 
                        </div>
                    </div>

                    <div id="chart-container" class="bg-white p-6 rounded-lg shadow mb-8"></div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Session History</h2>
                        <button onclick="handleNewSession()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                             New Session
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${(coach.sessions || []).length > 0 ? (coach.sessions || []).sort((a,b) => new Date(b.date) - new Date(a.date)).map(session => `
                            <div onclick='handleSelectSession(${JSON.stringify(session)})' class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer">
                                <p class="font-semibold text-gray-900">Session: ${new Date(session.date).toLocaleDateString('en-NZ', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-600 mt-1">Focus: ${session.focus || 'N/A'}</p>
                            </div>`).join('') : `<p class="text-gray-500 md:col-span-2">No sessions recorded yet.</p>`
                        }
                    </div>
                </main>`;

            // Render Chart
            setTimeout(() => {
                const chartContainer = document.getElementById('chart-container');
                if (chartContainer && (coach.sessions || []).length > 0) {
                     const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
                     const chartData = (coach.sessions || []).map(session => {
                        const sessionData = { date: new Date(session.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) };
                        (session.feedback || []).forEach(fb => { sessionData[fb.category] = fb.score; });
                        return sessionData;
                     });
                     const categories = Object.keys(rubricData);
                     const colors = ['#00a99d', '#002d3c', '#ffc658', '#8884d8', '#ff8042'];

                     const chart = React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
                         React.createElement(BarChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                             React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                             React.createElement(XAxis, { dataKey: "date" }),
                             React.createElement(YAxis, { domain: [0, 5], allowDecimals: false }),
                             React.createElement(Tooltip, null),
                             React.createElement(Legend, null),
                             ...categories.map((cat, index) => React.createElement(Bar, { key: cat, dataKey: cat, fill: colors[index % colors.length], name: cat.replace("Understands ","")}))
                         )
                     );
                     chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Progress Over Time</h3>`;
                     const chartRoot = document.createElement('div');
                     chartRoot.style.width = '100%';
                     chartRoot.style.height = '400px';
                     chartContainer.appendChild(chartRoot);
                     ReactDOM.render(chart, chartRoot);
                } else if(chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }, 0);
            return el;
        }

        function SessionFeedbackScreen() {
             const el = document.createElement('div');
             el.className = 'p-4 md:p-8';
             const coach = state.coaches[state.selectedCoachId];
              // Ensure coach exists before proceeding
             if (!coach) {
                 el.innerHTML = `<p class="text-red-600">Error: Cannot load session, coach not found.</p>`;
                 return el;
             }
             // Deep clone session to avoid modifying state directly during editing
             let session = state.selectedSession ? JSON.parse(JSON.stringify(state.selectedSession)) : {
                id: `session-${Date.now()}-${Math.random().toString(16).slice(2)}`, 
                date: new Date().toISOString().split('T')[0], 
                focus: '',
                feedback: Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' })),
                summary: '', 
                actionPlan: '', 
                athleteFeedback: ''
             };
              // Ensure feedback array exists and is populated
             if (!session.feedback || session.feedback.length !== Object.keys(rubricData).length) {
                session.feedback = Object.keys(rubricData).map(cat => {
                    const existing = (session.feedback || []).find(f => f.category === cat);
                    return existing || { category: cat, score: null, comments: '' };
                });
             }
             
             el.innerHTML = `
                ${Header({ title: `${state.selectedSession ? 'Edit' : 'New'} Session for ${coach.name}`, onBack: 'handleBack()' })}
                <main id="session-form" class="mt-8">
                    <!-- form content will be injected here -->
                </main>
             `;

             // Build and attach form to avoid innerHTML event listener issues
             setTimeout(() => {
                const formContainer = document.getElementById('session-form');
                if(!formContainer) return;
                
                const athleteFeedbackButtonHTML = session.athleteFeedback 
                    ? `<button onclick="handleGetAthleteFeedback()" class="bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        View Athlete Feedback
                       </button>`
                    : `<button onclick="handleGetAthleteFeedback()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Get Athlete Feedback</button>`;

                const formHTML = `
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <label for="date" class="font-medium text-gray-700 block mb-2">Session Date:</label>
                                <input type="date" name="date" value="${session.date}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                            <div>
                                <label for="focus" class="font-medium text-gray-700 block mb-2">Session Focus:</label>
                                <input type="text" name="focus" value="${session.focus || ''}" placeholder="e.g., Technical drills, race prep" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                            <div class="md:col-span-2">
                                ${athleteFeedbackButtonHTML}
                            </div>
                        </div>
                    </div>
                    ${Object.entries(rubricData).map(([category, data]) => {
                        const currentFeedback = (session.feedback || []).find(f => f.category === category) || { score: null, comments: "" };
                        return `
                        <div class="bg-white p-6 rounded-lg shadow mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">${category}</h3>
                            <p class="text-sm text-gray-500">${data.description}</p>
                            <div class="mt-6">
                               <div class="flex justify-between text-xs text-gray-600 px-1 mb-4">
                                ${[...Array(6)].map((_, i) => `<button data-cat="${category}" data-score="${i}" class="score-btn w-10 h-10 flex items-center justify-center rounded-full transition-colors ${currentFeedback.score === i ? 'bg-[#00a99d] text-white font-bold' : 'bg-gray-200 hover:bg-teal-100'}">${i}</button>`).join('')}
                               </div>
                               <p class="text-gray-700 mb-4 h-12"><strong>Description: </strong><span id="desc-${category.replace(/\s+/g, '')}">${currentFeedback.score !== null && currentFeedback.score > -1 ? data.levels[currentFeedback.score] : "Select a rating."}</span></p>
                               <textarea name="comments" data-cat="${category}" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Add specific examples...">${currentFeedback.comments || ''}</textarea>
                            </div>
                        </div>`
                    }).join('')}
                     <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Session Summary</h3>
                        <div>
                            <label for="summary" class="font-medium text-gray-700 block mb-2">Key Takeaways:</label>
                            <textarea name="summary" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.summary || ''}</textarea>
                         </div>
                         <div class="mt-4">
                            <label for="actionPlan" class="font-medium text-gray-700 block mb-2">Action Plan / Next Steps:</label>
                            <textarea name="actionPlan" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.actionPlan || ''}</textarea>
                         </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="save-btn" class="bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69]">Save Session Feedback</button>
                    </div>`;

                formContainer.innerHTML = formHTML;

                formContainer.querySelectorAll('.score-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.dataset.cat;
                        const score = parseInt(btn.dataset.score);
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        if(fbIndex === -1) { return; } 
                        session.feedback[fbIndex].score = score;
                        
                        document.getElementById(`desc-${category.replace(/\s+/g, '')}`).textContent = rubricData[category].levels[score];
                        formContainer.querySelectorAll(`.score-btn[data-cat="${category}"]`).forEach(b => {
                            b.classList.toggle('bg-[#00a99d]', parseInt(b.dataset.score) === score);
                            b.classList.toggle('text-white', parseInt(b.dataset.score) === score);
                            b.classList.toggle('font-bold', parseInt(b.dataset.score) === score);
                            b.classList.toggle('bg-gray-200', parseInt(b.dataset.score) !== score);
                        });
                    });
                });

                document.getElementById('save-btn').addEventListener('click', () => {
                    session.date = formContainer.querySelector('input[name="date"]').value;
                    session.focus = formContainer.querySelector('input[name="focus"]').value;
                    session.summary = formContainer.querySelector('textarea[name="summary"]').value;
                    session.actionPlan = formContainer.querySelector('textarea[name="actionPlan"]').value;
                    formContainer.querySelectorAll('textarea[name="comments"]').forEach(textarea => {
                        const category = textarea.dataset.cat;
                         const fbIndex = session.feedback.findIndex(f => f.category === category);
                         if (fbIndex > -1) { 
                             session.feedback[fbIndex].comments = textarea.value;
                         } 
                    });
                    // Preserve existing athlete feedback when saving other session details
                     session.athleteFeedback = state.selectedSession?.athleteFeedback || session.athleteFeedback || ''; 
                    handleSaveSession(session);
                });

             }, 0);

             return el;
        }

        function AthleteFeedbackScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
             if (!state.selectedCoachId || !state.coaches[state.selectedCoachId] || !state.selectedSession) {
                 el.innerHTML = `<p class="text-red-600">Error: Cannot load feedback screen, missing data.</p>`;
                 return el;
             }
            const coach = state.coaches[state.selectedCoachId];
            const session = state.selectedSession;

            el.innerHTML = `
                ${Header({ title: `Athlete Feedback`, onBack: 'handleBack()' })}
                <main class="mt-8 max-w-4xl mx-auto">
                     <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h2 class="text-2xl font-bold text-gray-800">Feedback for ${coach.name}</h2>
                        <p class="text-gray-600 mt-1">Session on ${new Date(session.date).toLocaleDateString('en-NZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="text-gray-600">Focus: ${session.focus || 'N/A'}</p>
                        
                        <div class="mt-6 text-left">
                            <label for="athlete-feedback-textarea" class="font-medium text-gray-700 block mb-2">Your Feedback:</label>
                            <textarea id="athlete-feedback-textarea" class="w-full p-2 border border-gray-300 rounded-md h-48" placeholder="Please provide your honest feedback about the session...">${session.athleteFeedback || ''}</textarea>
                        </div>

                        <div class="mt-6">
                            <button onclick="handleSaveAthleteFeedback()" class="bg-[#002d3c] text-white font-bold py-3 px-8 rounded-lg hover:bg-[#004e69] transition-colors text-lg">
                                Save and Finish
                            </button>
                        </div>
                     </div>
                </main>
            `;
            return el;
        }
        
        function CoachNotFoundScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8 flex flex-col items-center justify-center h-screen text-center';
            const logoutButton = `<button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mt-6">Logout</button>`;
             el.innerHTML = `
                <img src="bop-logo.png" alt="Bay of Plenty Rowing Logo" class="w-48 mx-auto mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Profile Not Ready</h1>
                <p class="text-gray-600">Your coach profile has not been created by the administrator yet.</p>
                <p class="text-gray-600">Please contact ${ADMIN_EMAIL} to have your profile set up before you can use the app.</p>
                ${logoutButton}
             `;
             return el;
        }


        // --- INITIALIZATION ---
        let unsubscribe; // To hold the onSnapshot listener

        async function loadDataForUser(user) {
            if (!user || !user.uid) {
                 console.log("loadDataForUser: No user found, proceeding to logout state.");
                 setState({ user: null, loading: false }); // Ensure loading stops if somehow called without user
                 return;
             }
            
            console.log("loadDataForUser: Loading data for user", user.email);
            setState({ loading: true, loadingMessage: "Loading coach data...", coachProfileNotFound: false }); 
            
            const isAdmin = user.email === ADMIN_EMAIL;
            let dataQuery;
            
            if (isAdmin) {
                console.log("User is Admin, fetching all coaches.");
                dataQuery = query(collection(db, 'coaches'));
            } else {
                console.log("User is Coach, fetching profile for email:", user.email);
                dataQuery = query(collection(db, 'coaches'), where("email", "==", user.email));
            }

            // Clean up previous listener if exists
            if (unsubscribe) {
                 console.log("Unsubscribing from previous listener.");
                 unsubscribe();
                 unsubscribe = null;
             }

            console.log("Setting up Firestore listener...");
            unsubscribe = onSnapshot(dataQuery, (querySnapshot) => {
                console.log(`Firestore snapshot received. Admin: ${isAdmin}, Empty: ${querySnapshot.empty}, Size: ${querySnapshot.size}`);
                const coachesData = {};
                querySnapshot.forEach((doc) => {
                    coachesData[doc.id] = { id: doc.id, ...doc.data() };
                });

                if (!isAdmin && querySnapshot.empty) {
                    console.log("Coach profile not found for email:", user.email);
                    setState({ 
                        isAdmin: false, 
                        coaches: {}, 
                        loading: false, 
                        coachProfileNotFound: true,
                        currentView: 'coachList' 
                    });
                } else if (!isAdmin && querySnapshot.size === 1) {
                    const coachId = querySnapshot.docs[0].id;
                    console.log("Coach profile found:", coachId);
                    setState({ 
                        isAdmin: false, 
                        coaches: coachesData, 
                        loading: false, 
                        coachProfileNotFound: false,
                        selectedCoachId: coachId, 
                        currentView: 'coachDetail' 
                    });
                }
                 else { // Admin gets all data, or handles coach error case (multiple profiles found)
                     if (!isAdmin && querySnapshot.size > 1) {
                         console.warn("Multiple coach profiles found for email:", user.email, "Displaying 'Not Found' screen.");
                         // Treat as profile not found to prevent unexpected behavior
                         setState({ 
                            isAdmin: false, 
                            coaches: {}, 
                            loading: false, 
                            coachProfileNotFound: true,
                            currentView: 'coachList' 
                         });
                     } else { // Admin case
                        console.log("Admin data loaded:", Object.keys(coachesData).length, "coaches found.");
                        setState({ 
                            isAdmin: true, 
                            coaches: coachesData, 
                            loading: false, 
                            coachProfileNotFound: false,
                            currentView: state.currentView === 'coachList' ? 'coachList' : state.currentView, // Preserve view unless it was default
                            selectedCoachId: state.selectedCoachId // Preserve selection if any
                         });
                     }
                }

            }, (error) => {
                console.error("Firestore onSnapshot Error: ", error);
                alert("Could not load coach data. Check console for an error message (potentially Firestore Rules).");
                // Attempt to gracefully handle error, maybe logout or show limited view
                 setState({ 
                    loading: false, 
                    coachProfileNotFound: false, 
                    // Consider logging out or showing an error screen instead of just stopping loading
                    // For now, stop loading and let the UI decide based on user/admin status
                    currentView: 'coachList' // Reset view
                 }); 
            });
        }

        // --- MODAL & BACKUP/RESTORE HANDLING ---
        window.openCoachModal = (coachId = null) => {
            if (!state.isAdmin) return; 

            const modal = document.getElementById('coach-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('coach-name-input');
            const emailInput = document.getElementById('coach-email-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');

            // Populate club dropdown
            clubSelect.innerHTML = clubs.map(club => `<option value="${club}">${club}</option>`).join('');

            if (coachId) {
                // Editing existing coach
                const coach = state.coaches[coachId];
                 if (!coach) {
                     console.error("Cannot open edit modal, coach not found for ID:", coachId);
                     return;
                 }
                title.textContent = 'Edit Coach Profile';
                nameInput.value = coach.name || '';
                emailInput.value = coach.email || '';
                clubSelect.value = coach.club || clubs[0]; // Default if no club
                coachIdInput.value = coachId;
            } else {
                // Adding new coach
                title.textContent = 'Add New Coach Profile';
                nameInput.value = '';
                emailInput.value = '';
                clubSelect.value = clubs[0];
                coachIdInput.value = '';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        function closeCoachModal() {
            const modal = document.getElementById('coach-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveCoach() {
             if (!state.isAdmin) return; 

            const nameInput = document.getElementById('coach-name-input');
            const emailInput = document.getElementById('coach-email-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');
            
            const name = nameInput.value.trim();
            const email = emailInput.value.trim().toLowerCase();
            const club = clubSelect.value;
            const coachId = coachIdInput.value;

            if (!name || !email) {
                alert("Please enter both coach's name and login email.");
                return;
            }
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                alert("Please enter a valid email address.");
                return;
            }


            if (!state.user || !state.user.uid) {
                 alert("Could not save coach profile because you are not properly signed in. Please refresh the page.");
                 return;
            }

            try {
                 const q = query(collection(db, "coaches"), where("email", "==", email));
                 const querySnapshot = await getDocs(q);
                 let emailInUse = false;
                 querySnapshot.forEach((doc) => {
                     if (doc.id !== coachId) { 
                         emailInUse = true;
                     }
                 });

                 if (emailInUse) {
                     alert(`The email address ${email} is already assigned to another coach profile. Please use a unique email.`);
                     return;
                 }

                if (coachId) {
                    const coachRef = doc(db, 'coaches', coachId);
                    await updateDoc(coachRef, { name, email, club });
                     alert('Coach profile updated. Make sure the user account exists in Firebase Authentication.');
                } else {
                    await addDoc(collection(db, 'coaches'), {
                        name,
                        email, 
                        club,
                        sessions: [],
                        goals: '', 
                        userId: state.user.uid // Admin's UID is the owner/creator
                    });
                     alert('Coach profile created. The coach can now sign up using this email, or if they already have an account, they can log in.');
                }
                closeCoachModal();
            } catch (error) {
                console.error("Error saving coach profile: ", error);
                alert("Failed to save coach profile. Please check the console for errors.");
            }
        }
        
        window.handleBackupData = () => {
             if (!state.isAdmin) return; 
            if (Object.keys(state.coaches).length === 0) {
                alert("There is no data to back up.");
                return;
            }
            try {
                const dataStr = JSON.stringify(state.coaches, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                link.download = `boprcf_backup_${date}.json`;
                link.href = url;
                link.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } catch (error) {
                console.error("Backup failed:", error);
                alert("Could not create backup file.");
            }
        };

        window.handleRestoreClick = () => {
             if (!state.isAdmin) return; 
            document.getElementById('restore-input').click();
        };

        async function handleFileSelected(event) {
             if (!state.isAdmin) return; 

            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("ADMIN ACTION: Are you sure you want to restore from this file? This will permanently delete ALL current coach data and replace it with the data from the backup. This action cannot be undone.")) {
                event.target.value = null; // Clear selection
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                let initialLoadingState = state.loading; // Store initial state
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    if (typeof restoredData !== 'object' || restoredData === null) {
                        throw new Error("Invalid backup file format: Root must be an object.");
                    }
                     // More validation: check if values are objects with expected fields?
                     // Example: check if first entry has a 'name' field
                     const firstEntryKey = Object.keys(restoredData)[0];
                     if (firstEntryKey && typeof restoredData[firstEntryKey].name === 'undefined') {
                         console.warn("Backup file format might be incorrect. Missing 'name' field in first entry.");
                         // Decide whether to throw error or proceed cautiously
                         // throw new Error("Invalid backup file format: Missing 'name' field.");
                     }


                    setState({ loading: true, loadingMessage: "Restoring data..." });

                    // Delete ALL existing coaches 
                    const currentCoachesSnapshot = await getDocs(collection(db, 'coaches'));
                    const deletePromises = currentCoachesSnapshot.docs.map(d => deleteDoc(d.ref));
                    await Promise.all(deletePromises);
                    console.log("Existing coaches deleted.");

                    // Add all coaches from the backup file
                    const addPromises = Object.entries(restoredData).map(([coachId, coachData]) => {
                         // Ensure required fields exist, provide defaults
                        const dataToSave = { 
                            name: coachData.name || "Unnamed Coach",
                            email: coachData.email || null, // Allow null email if missing
                            club: coachData.club || null,
                            sessions: coachData.sessions || [],
                            goals: coachData.goals || '', 
                            userId: coachData.userId || state.user.uid // Default to current admin if missing
                         };
                        console.log("Restoring coach:", coachId, dataToSave.email);
                        // Use the original ID from the backup file as the document ID
                        return setDoc(doc(db, 'coaches', coachId), dataToSave); 
                    });
                    await Promise.all(addPromises);

                    alert("Restore successful! All data has been updated.");
                    console.log("Restore complete.");

                } catch (error) {
                    console.error("Restore failed:", error);
                    alert(`Restore failed: ${error.message}`);
                } finally {
                     // Reset loading state after operation (success or fail)
                     // Re-trigger data load explicitly if needed, otherwise rely on listener if still active
                     // If listener was detached, need to re-attach
                    console.log("Restore operation finished. Reloading data...");
                     // Let onAuthStateChanged handle reloading if user is still logged in
                     // setState({ loading: false }); // Directly set loading false
                     // OR Trigger reload manually:
                     if (state.user) {
                         loadDataForUser(state.user); // This will set loading=false on completion/error
                     } else {
                         setState({ loading: false }); // If somehow user logged out during restore
                     }
                    event.target.value = null; // Clear file input
                }
            };
            reader.onerror = () => {
                 alert('Failed to read the backup file.');
                 event.target.value = null; // Clear file input
            };
            reader.readAsText(file);
        }


        // --- APP STARTUP ---
        let initialAuthCheckComplete = false;
        console.log("Setting up Auth State Listener...");
        onAuthStateChanged(auth, (currentUser) => {
            console.log("Auth State Changed. Current User:", currentUser ? currentUser.email : "null");
            initialAuthCheckComplete = true; 
            if (currentUser) {
                 // User is signed in. Proceed to load data.
                 loadDataForUser(currentUser); 
            } else {
                // User is signed out or initial state is null.
                console.log("User is signed out.");
                if (unsubscribe) {
                     console.log("Unsubscribing from Firestore listener.");
                     unsubscribe(); 
                     unsubscribe = null;
                }
                // Reset application state completely and show login screen
                setState({ 
                    user: null, 
                    isAdmin: false, 
                    loading: false, // Ensure loading is false to show login
                    coaches: {}, 
                    coachProfileNotFound: false,
                    currentView: 'coachList', // Reset view
                    selectedCoachId: null,
                    selectedSession: null,
                    searchQuery: ''
                 });
            }
        });
         // Handle case where listener might not fire immediately
         setTimeout(() => {
            if (!initialAuthCheckComplete) {
                console.warn("Auth state listener did not fire within 2 seconds. Assuming logged out.");
                 if (!state.user) { // Only update if still no user
                    setState({ loading: false }); // Force loading off to show login screen
                 }
            }
         }, 2000); // 2 second timeout


        // Attach modal and file input event listeners (Ensure DOM is ready)
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Attaching listeners.");
            const saveBtn = document.getElementById('save-coach-button');
            const cancelBtn = document.getElementById('cancel-coach-modal');
            const restoreInput = document.getElementById('restore-input');

            if (saveBtn) saveBtn.addEventListener('click', saveCoach);
            else console.error("Save coach button not found");

            if(cancelBtn) cancelBtn.addEventListener('click', closeCoachModal);
            else console.error("Cancel coach modal button not found");

            if(restoreInput) restoreInput.addEventListener('change', handleFileSelected);
            else console.error("Restore file input not found");
        });


    </script>
</body>
</html>

