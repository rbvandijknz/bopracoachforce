<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOP Rowing Coach Development</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .login-card {
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Add/Edit Coach Modal -->
    <div id="coach-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add New Coach</h2>
            <input type="hidden" id="coach-id-input">
            <div class="space-y-4">
                <div>
                    <label for="coach-name-input" class="block text-sm font-medium text-gray-700">Coach Name</label>
                    <input type="text" id="coach-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                </div>
                <div>
                    <label for="coach-club-select" class="block text-sm font-medium text-gray-700">Club</label>
                    <select id="coach-club-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-coach-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-coach-button" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69]">Save Coach</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, query, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVbGWN3LclrUZMtv-L7x0D8HF7OQ3viK8",
            authDomain: "bopracoachfeedback.firebaseapp.com",
            projectId: "bopracoachfeedback",
            storageBucket: "bopracoachfeedback.appspot.com",
            messagingSenderId: "967552327697",
            appId: "1:967552327697:web:f3a2e3ffa5d6c6a3f611b0",
            measurementId: "G-NRQ2HSJGT6"
        };

        // --- RUBRIC DATA ---
        const rubricData = {
          "Understands the Sport": { description: "(technical, tactical, rules)", levels: ["Open to learning sport-specific knowledge.", "Starting to notice techniques and rules in action.", "Beginning to apply knowledge of techniques and rules with athletes.", "Using sport knowledge intentionally with athletes.", "Adapting technical/tactical elements confidently.", "Mentoring and sharing sport knowledge with others."] },
          "Understands Self": { description: "(leadership, philosophy, self-awareness, communication)", levels: ["Becoming aware of the coaching role and its impact.", "Noticing different coaching styles and effects.", "Starting to reflect on personal coaching style and values.", "Established a coaching philosophy and starting to implement.", "Adapting communication and coaching style to suit others' needs.", "Supporting others through clear, authentic leadership."] },
          "Understands Environment": { description: "(culture, learning space)", levels: ["Beginning to consider how environment affects learning.", "Noticing group dynamics and inclusion opportunities.", "Trying new strategies to include and engage all athletes.", "Creating space that supports trust and growth.", "Shaping a positive culture through deliberate actions.", "Supporting athletes in co-creating a positive environment."] },
          "Understands Learning": { description: "(reflection, planning, pedagogy/andragogy)", levels: ["Starting to think about how people learn.", "Noticing different learning preferences and athlete needs.", "Planning sessions with learning styles and athlete needs in mind (Athlete-centred).", "Adapting activities based on reflection and feedback.", "Applying learning theory with confidence.", "Designing learning based on individual needs and goals."] },
          "Understands Development": { description: "(age & stage, feedback, development)", levels: ["Building awareness of how athletes develop.", "Reflecting on sessions relative to age and stage.", "Planning sessions with the development needs of age and stage in mind.", "Providing purposeful feedback and clear expectations relative to age and stage.", "Balancing support with challenge in meaningful ways.", "Transforming performance through reflective support."] }
        };
        const levelNames = ["Emerging", "Exploring", "Developing", "Applying", "Integrating", "Leading"];
        const clubs = ["Bay of Plenty Coast", "Rotorua", "Taupo", "Tauranga", "Whakatane", "Tauranga Boys' College"];
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- APPLICATION STATE ---
        let state = {
            loading: true,
            user: null, // This will be the firebase user object or null
            coaches: {},
            currentView: 'coachList', // Default view if logged in
            selectedCoachId: null,
            selectedSession: null,
        };
        
        const root = document.getElementById('app');

        // --- STATE MANAGEMENT & RENDERING ---
        function setState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        function renderApp() {
            root.innerHTML = ''; // Clear the screen
            
            if (state.loading) {
                 root.innerHTML = `<div class="flex justify-center items-center h-screen bg-gray-50"><p class="text-lg text-gray-700">Loading Application...</p></div>`;
                 return;
            }
            
            if (!state.user) {
                root.appendChild(LoginScreen());
                return;
            }

            switch(state.currentView) {
                case 'coachDetail':
                    root.appendChild(CoachDetailScreen());
                    break;
                case 'sessionFeedback':
                    root.appendChild(SessionFeedbackScreen());
                    break;
                case 'coachList':
                default:
                    root.appendChild(CoachListScreen());
                    break;
            }
        }
        
        // --- DATA HANDLING & NAVIGATION ---
        window.handleSelectCoach = (coachId) => setState({ selectedCoachId: coachId, currentView: 'coachDetail' });
        window.handleSelectSession = (session) => setState({ selectedSession: session, currentView: 'sessionFeedback' });
        window.handleNewSession = () => setState({ selectedSession: null, currentView: 'sessionFeedback' });
        window.handleBack = () => {
            if (state.currentView === 'sessionFeedback') setState({ currentView: 'coachDetail' });
            else if (state.currentView === 'coachDetail') setState({ currentView: 'coachList', selectedCoachId: null });
        };
       
        window.handleSaveSession = async (sessionData) => {
            const coachRef = doc(db, 'coaches', state.selectedCoachId);
            const coachToUpdate = state.coaches[state.selectedCoachId];
            const sessionIndex = coachToUpdate.sessions.findIndex(s => s.id === sessionData.id);
            let updatedSessions = sessionIndex > -1 
                ? coachToUpdate.sessions.map(s => s.id === sessionData.id ? sessionData : s)
                : [...coachToUpdate.sessions, sessionData];
            await updateDoc(coachRef, { sessions: updatedSessions });
            setState({ currentView: 'coachDetail' });
        };
        
        window.handleDeleteCoach = async (coachId, coachName) => {
             if (confirm(`Are you sure you want to delete ${coachName}? This action cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, 'coaches', coachId));
                } catch (error) {
                    console.error("Error deleting coach:", error);
                    alert("Failed to delete coach. Please try again.");
                }
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
        };
        
        window.handleSaveGoals = async () => {
            const goalsTextarea = document.getElementById('coach-goals-textarea');
            if (!goalsTextarea) return;

            const newGoals = goalsTextarea.value;
            const coachRef = doc(db, 'coaches', state.selectedCoachId);

            try {
                await updateDoc(coachRef, { goals: newGoals });
                alert('Goals saved successfully!');
            } catch (error) {
                console.error("Error saving goals:", error);
                alert("Failed to save goals. Please try again.");
            }
        };

        // --- "COMPONENTS" (DOM element factories) ---
        function LoginScreen() {
            const el = document.createElement('div');
            el.className = 'flex flex-col justify-center items-center h-screen bg-gray-100 p-4';
            el.innerHTML = `
                <div class="login-card bg-white p-8 rounded-xl shadow-lg text-center">
                    <img src="https://lh3.googleusercontent.com/sitesv/AICyYdYLV_D6MzzdTnPC1n1ljg6hMm-229Rpj6cihcwkvHFQVEu5ZRP8SiEP-YDz9sdPOdqL5kY1Fw7J9YJ13UpAJE4saMpH96fy4DPzVIsLac_FIeuRAWpqPSnlEVIaZPRt6yjlp9PCM6SvgNkoAKGR6hoejuASF2sQiJH22TWGLFQWG-cDKnQafTTd=w16383" alt="Bay of Plenty Rowing Logo" class="w-48 mx-auto mb-6">
                    <h1 id="auth-title" class="text-2xl font-bold text-gray-800 mb-2">Login</h1>
                    <p class="text-gray-600 mb-6">Enter your credentials to access your coach data.</p>
                    <div class="space-y-4 text-left">
                        <div>
                           <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                           <input id="email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        </div>
                        <div>
                           <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                           <input id="password" type="password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-[#00a99d] focus:border-[#00a99d]">
                        </div>
                    </div>
                    <button id="auth-button" class="mt-6 w-full bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69] transition-colors text-lg">
                        Sign In
                    </button>
                    <p id="error-message" class="text-red-500 mt-4 h-5"></p>
                </div>
            `;
            
            setTimeout(() => {
                const button = el.querySelector('#auth-button');
                const emailInput = el.querySelector('#email');
                const passwordInput = el.querySelector('#password');
                const errorMsg = el.querySelector('#error-message');
                const ALLOWED_EMAIL = 'merowing@xtra.co.nz';

                button.addEventListener('click', async () => {
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    errorMsg.textContent = '';

                    if (email.toLowerCase() !== ALLOWED_EMAIL) {
                        errorMsg.textContent = 'Invalid email address.';
                        return;
                    }

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        errorMsg.textContent = error.message.replace('Firebase: ','');
                    }
                });

            }, 0);

            return el;
        }

        function Header({ title, onBack, rightContent }) {
            return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center w-full sticky top-0 z-20">
                    <div class="flex items-center">
                        ${onBack ? `<button onclick="${onBack}" class="p-2 mr-4 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>` : ''}
                        <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                    </div>
                    <div>${rightContent || ''}</div>
                </header>`;
        }
        
        function CoachListScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            const logoutButton = `<button onclick="handleLogout()" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Logout</button>`;
            el.innerHTML = `
                ${Header({ title: "Rowing Coaches", rightContent: logoutButton })}
                <main class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.entries(state.coaches).map(([id, coach]) => `
                        <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow flex items-center justify-between space-x-4">
                           <div class="flex items-center space-x-4 cursor-pointer flex-grow" onclick="handleSelectCoach('${id}')">
                                <div class="bg-[#00a99d] rounded-full p-3 text-white flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${coach.name}</h3>
                                    <p class="text-sm text-gray-600">${coach.club || 'No club assigned'}</p>
                                    <p class="text-xs text-gray-400 mt-1">${coach.sessions.length} session${coach.sessions.length !== 1 ? 's' : ''} recorded</p>
                                </div>
                            </div>
                            <button onclick="handleDeleteCoach('${id}', '${coach.name}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>`).join('')}
                    <button onclick="openCoachModal()" class="bg-gray-100 p-4 rounded-lg border-2 border-dashed border-gray-300 hover:border-[#00a99d] hover:bg-teal-50 transition-all flex flex-col items-center justify-center text-gray-500 hover:text-[#00a99d]">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="mt-2 font-semibold">Add New Coach</span>
                    </button>
                </main>`;
            return el;
        }
        
        function CoachDetailScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            const coach = state.coaches[state.selectedCoachId];

            const editButton = `<button onclick="openCoachModal('${state.selectedCoachId}')" class="text-sm bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit Coach
            </button>`;

            el.innerHTML = `
                ${Header({ title: coach.name, onBack: 'handleBack()', rightContent: editButton })}
                <main class="mt-8">
                    <p class="text-lg font-semibold text-[#00a99d] -mt-4 mb-6">${coach.club || 'No Club Assigned'}</p>
                    
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Goals</h2>
                        <textarea id="coach-goals-textarea" class="w-full p-2 border border-gray-300 rounded-md h-32" placeholder="Enter the coach's long-term development goals...">${coach.goals || ''}</textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="handleSaveGoals()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors">Save Goals</button>
                        </div>
                    </div>

                    <div id="chart-container" class="bg-white p-6 rounded-lg shadow mb-8"></div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Session History</h2>
                        <button onclick="handleNewSession()" class="bg-[#002d3c] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#004e69] transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                             New Session
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${coach.sessions.length > 0 ? coach.sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(session => `
                            <div onclick='handleSelectSession(${JSON.stringify(session)})' class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer">
                                <p class="font-semibold text-gray-900">Session: ${new Date(session.date).toLocaleDateString('en-NZ', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-600 mt-1">Focus: ${session.focus}</p>
                            </div>`).join('') : `<p class="text-gray-500 md:col-span-2">No sessions recorded yet.</p>`
                        }
                    </div>
                </main>`;

            // Render Chart
            setTimeout(() => {
                const chartContainer = document.getElementById('chart-container');
                if (chartContainer && coach.sessions.length > 0) {
                     const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
                     const chartData = coach.sessions.map(session => {
                        const sessionData = { date: new Date(session.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) };
                        session.feedback.forEach(fb => { sessionData[fb.category] = fb.score; });
                        return sessionData;
                     });
                     const categories = Object.keys(rubricData);
                     const colors = ['#00a99d', '#002d3c', '#ffc658', '#8884d8', '#ff8042'];

                     const chart = React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
                         React.createElement(BarChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                             React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                             React.createElement(XAxis, { dataKey: "date" }),
                             React.createElement(YAxis, { domain: [0, 5], allowDecimals: false }),
                             React.createElement(Tooltip, null),
                             React.createElement(Legend, null),
                             ...categories.map((cat, index) => React.createElement(Bar, { key: cat, dataKey: cat, fill: colors[index % colors.length], name: cat.replace("Understands ","")}))
                         )
                     );
                     chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Progress Over Time</h3>`;
                     const chartRoot = document.createElement('div');
                     chartRoot.style.width = '100%';
                     chartRoot.style.height = '400px';
                     chartContainer.appendChild(chartRoot);
                     ReactDOM.render(chart, chartRoot);
                } else if(chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }, 0);
            return el;
        }

        function SessionFeedbackScreen() {
             const el = document.createElement('div');
             el.className = 'p-4 md:p-8';
             const coach = state.coaches[state.selectedCoachId];
             let session = state.selectedSession || {
                id: `session-${Date.now()}`, date: new Date().toISOString().split('T')[0], focus: '',
                feedback: Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' })),
                summary: '', actionPlan: ''
             };
             
             el.innerHTML = `
                ${Header({ title: `${state.selectedSession ? 'Edit' : 'New'} Session for ${coach.name}`, onBack: 'handleBack()' })}
                <main id="session-form" class="mt-8">
                    <!-- form content will be injected here -->
                </main>
             `;

             // Build and attach form to avoid innerHTML event listener issues
             setTimeout(() => {
                const formContainer = document.getElementById('session-form');
                if(!formContainer) return;
                
                const formHTML = `
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="date" class="font-medium text-gray-700 block mb-2">Session Date:</label>
                                <input type="date" name="date" value="${session.date}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                            <div>
                                <label for="focus" class="font-medium text-gray-700 block mb-2">Session Focus:</label>
                                <input type="text" name="focus" value="${session.focus}" placeholder="e.g., Technical drills, race prep" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#00a99d] focus:border-[#00a99d] transition" />
                            </div>
                        </div>
                    </div>
                    ${Object.entries(rubricData).map(([category, data]) => {
                        const currentFeedback = session.feedback.find(f => f.category === category) || { score: -1, comments: "" };
                        return `
                        <div class="bg-white p-6 rounded-lg shadow mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">${category}</h3>
                            <p class="text-sm text-gray-500">${data.description}</p>
                            <div class="mt-6">
                               <div class="flex justify-between text-xs text-gray-600 px-1 mb-4">
                                ${[...Array(6)].map((_, i) => `<button data-cat="${category}" data-score="${i}" class="score-btn w-10 h-10 flex items-center justify-center rounded-full transition-colors ${currentFeedback.score === i ? 'bg-[#00a99d] text-white font-bold' : 'bg-gray-200 hover:bg-teal-100'}">${i}</button>`).join('')}
                               </div>
                               <p class="text-gray-700 mb-4 h-12"><strong>Description: </strong><span id="desc-${category.replace(/\s+/g, '')}">${currentFeedback.score > -1 ? data.levels[currentFeedback.score] : "Select a rating."}</span></p>
                               <textarea name="comments" data-cat="${category}" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Add specific examples...">${currentFeedback.comments}</textarea>
                            </div>
                        </div>`
                    }).join('')}
                     <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Session Summary</h3>
                        <div>
                            <label for="summary" class="font-medium text-gray-700 block mb-2">Key Takeaways:</label>
                            <textarea name="summary" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.summary}</textarea>
                         </div>
                         <div class="mt-4">
                            <label for="actionPlan" class="font-medium text-gray-700 block mb-2">Action Plan / Next Steps:</label>
                            <textarea name="actionPlan" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.actionPlan}</textarea>
                         </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="save-btn" class="bg-[#002d3c] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004e69]">Save Session Feedback</button>
                    </div>`;

                formContainer.innerHTML = formHTML;

                formContainer.querySelectorAll('.score-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.dataset.cat;
                        const score = parseInt(btn.dataset.score);
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        session.feedback[fbIndex].score = score;
                        
                        // Update UI
                        document.getElementById(`desc-${category.replace(/\s+/g, '')}`).textContent = rubricData[category].levels[score];
                        formContainer.querySelectorAll(`.score-btn[data-cat="${category}"]`).forEach(b => {
                            b.classList.toggle('bg-[#00a99d]', parseInt(b.dataset.score) === score);
                            b.classList.toggle('text-white', parseInt(b.dataset.score) === score);
                            b.classList.toggle('font-bold', parseInt(b.dataset.score) === score);
                            b.classList.toggle('bg-gray-200', parseInt(b.dataset.score) !== score);
                        });
                    });
                });

                document.getElementById('save-btn').addEventListener('click', () => {
                    session.date = formContainer.querySelector('input[name="date"]').value;
                    session.focus = formContainer.querySelector('input[name="focus"]').value;
                    session.summary = formContainer.querySelector('textarea[name="summary"]').value;
                    session.actionPlan = formContainer.querySelector('textarea[name="actionPlan"]').value;
                    formContainer.querySelectorAll('textarea[name="comments"]').forEach(textarea => {
                        const category = textarea.dataset.cat;
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        session.feedback[fbIndex].comments = textarea.value;
                    });
                    handleSaveSession(session);
                });

             }, 0);

             return el;
        }

        // --- INITIALIZATION ---
        let unsubscribe; // To hold the onSnapshot listener

        function loadDataForCurrentUser(user) {
            if (!user || !user.uid) return;
            
            const coachesQuery = query(collection(db, 'coaches'), where("userId", "==", user.uid));
            unsubscribe = onSnapshot(coachesQuery, (querySnapshot) => {
                const coachesData = {};
                querySnapshot.forEach((doc) => {
                    coachesData[doc.id] = { id: doc.id, ...doc.data() };
                });
                setState({ coaches: coachesData });
            }, (error) => {
                console.error("Firestore Error: ", error);
                alert("Could not load data. Check console for an error message.");
            });
        }

        // --- MODAL HANDLING ---
        window.openCoachModal = (coachId = null) => {
            const modal = document.getElementById('coach-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('coach-name-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');

            // Populate club dropdown
            clubSelect.innerHTML = clubs.map(club => `<option value="${club}">${club}</option>`).join('');

            if (coachId) {
                // Editing existing coach
                const coach = state.coaches[coachId];
                title.textContent = 'Edit Coach';
                nameInput.value = coach.name;
                clubSelect.value = coach.club;
                coachIdInput.value = coachId;
            } else {
                // Adding new coach
                title.textContent = 'Add New Coach';
                nameInput.value = '';
                clubSelect.value = clubs[0];
                coachIdInput.value = '';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        function closeCoachModal() {
            const modal = document.getElementById('coach-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveCoach() {
            const nameInput = document.getElementById('coach-name-input');
            const clubSelect = document.getElementById('coach-club-select');
            const coachIdInput = document.getElementById('coach-id-input');
            
            const name = nameInput.value.trim();
            const club = clubSelect.value;
            const coachId = coachIdInput.value;

            if (!name) {
                alert("Please enter a coach's name.");
                return;
            }

            if (!state.user || !state.user.uid) {
                 alert("Could not save coach because you are not properly signed in. Please refresh the page.");
                 return;
            }

            try {
                if (coachId) {
                    // Update existing coach
                    const coachRef = doc(db, 'coaches', coachId);
                    await updateDoc(coachRef, { name, club });
                } else {
                    // Add new coach
                    await addDoc(collection(db, 'coaches'), {
                        name,
                        club,
                        sessions: [],
                        goals: '', // Initialize goals field for new coaches
                        userId: state.user.uid
                    });
                }
                closeCoachModal();
            } catch (error) {
                console.error("Error saving coach: ", error);
                alert("Failed to save coach. Please check the console for errors.");
            }
        }

        // --- APP STARTUP ---
        onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
                // User is signed in.
                setState({ user: currentUser, loading: false, currentView: 'coachList' });
                loadDataForCurrentUser(currentUser);
            } else {
                // User is signed out.
                if (unsubscribe) unsubscribe(); // Stop listening to old data
                setState({ user: null, loading: false, coaches: {} });
            }
        });

        // Attach modal event listeners
        document.getElementById('save-coach-button').addEventListener('click', saveCoach);
        document.getElementById('cancel-coach-modal').addEventListener('click', closeCoachModal);

    </script>
</body>
</html>

