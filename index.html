<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Feedback App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .login-card {
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVbGWN3LclrUZMtv-L7x0D8HF7OQ3viK8",
            authDomain: "bopracoachfeedback.firebaseapp.com",
            projectId: "bopracoachfeedback",
            storageBucket: "bopracoachfeedback.appspot.com",
            messagingSenderId: "967552327697",
            appId: "1:967552327697:web:f3a2e3ffa5d6c6a3f611b0",
            measurementId: "G-NRQ2HSJGT6"
        };
        
        // --- ACCESS CODE ---
        const ACCESS_CODE = "COACH2025"; // Change this to your desired code

        // --- RUBRIC DATA ---
        const rubricData = {
          "Understands the Sport": { description: "(technical, tactical, rules)", levels: ["Open to learning sport-specific knowledge.", "Starting to notice techniques and rules in action.", "Beginning to apply knowledge of techniques and rules with athletes.", "Using sport knowledge intentionally with athletes.", "Adapting technical/tactical elements confidently.", "Mentoring and sharing sport knowledge with others."] },
          "Understands Self": { description: "(leadership, philosophy, self-awareness, communication)", levels: ["Becoming aware of the coaching role and its impact.", "Noticing different coaching styles and effects.", "Starting to reflect on personal coaching style and values.", "Established a coaching philosophy and starting to implement.", "Adapting communication and coaching style to suit others' needs.", "Supporting others through clear, authentic leadership."] },
          "Understands Environment": { description: "(culture, learning space)", levels: ["Beginning to consider how environment affects learning.", "Noticing group dynamics and inclusion opportunities.", "Trying new strategies to include and engage all athletes.", "Creating space that supports trust and growth.", "Shaping a positive culture through deliberate actions.", "Supporting athletes in co-creating a positive environment."] },
          "Understands Learning": { description: "(reflection, planning, pedagogy/andragogy)", levels: ["Starting to think about how people learn.", "Noticing different learning preferences and athlete needs.", "Planning sessions with learning styles and athlete needs in mind (Athlete-centred).", "Adapting activities based on reflection and feedback.", "Applying learning theory with confidence.", "Designing learning based on individual needs and goals."] },
          "Understands Development": { description: "(age & stage, feedback, development)", levels: ["Building awareness of how athletes develop.", "Reflecting on sessions relative to age and stage.", "Planning sessions with the development needs of age and stage in mind.", "Providing purposeful feedback and clear expectations relative to age and stage.", "Balancing support with challenge in meaningful ways.", "Transforming performance through reflective support."] }
        };
        const levelNames = ["Emerging", "Exploring", "Developing", "Applying", "Integrating", "Leading"];
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- APPLICATION STATE ---
        let state = {
            isLoggedIn: false,
            loading: false,
            user: null,
            coaches: {},
            currentView: 'login', // login, coachList, coachDetail, sessionFeedback
            selectedCoachId: null,
            selectedSession: null,
        };
        
        const root = document.getElementById('app');

        // --- STATE MANAGEMENT & RENDERING ---
        function setState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        function renderApp() {
            root.innerHTML = ''; // Clear the screen
            
            if (!state.isLoggedIn) {
                root.appendChild(LoginScreen());
                return;
            }

            if (state.loading) {
                root.innerHTML = `<div class="flex justify-center items-center h-screen bg-gray-50">
                    <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="ml-4 text-lg text-gray-700">Loading Coach Data...</p>
                </div>`;
                return;
            }

            switch(state.currentView) {
                case 'coachDetail':
                    root.appendChild(CoachDetailScreen());
                    break;
                case 'sessionFeedback':
                    root.appendChild(SessionFeedbackScreen());
                    break;
                case 'coachList':
                default:
                    root.appendChild(CoachListScreen());
                    break;
            }
        }
        
        // --- DATA HANDLING & NAVIGATION ---
        window.handleLoginAttempt = () => {
            const codeInput = document.getElementById('access-code');
            const errorMsg = document.getElementById('error-message');
            if (codeInput.value === ACCESS_CODE) {
                setState({ isLoggedIn: true, loading: true });
                initializeFirebaseAndLoadData();
            } else {
                errorMsg.textContent = 'Incorrect code. Please try again.';
                codeInput.classList.add('border-red-500');
            }
        };

        window.handleSelectCoach = (coachId) => setState({ selectedCoachId: coachId, currentView: 'coachDetail' });
        window.handleSelectSession = (session) => setState({ selectedSession: session, currentView: 'sessionFeedback' });
        window.handleNewSession = () => setState({ selectedSession: null, currentView: 'sessionFeedback' });
        window.handleBack = () => {
            if (state.currentView === 'sessionFeedback') setState({ currentView: 'coachDetail' });
            else if (state.currentView === 'coachDetail') setState({ currentView: 'coachList', selectedCoachId: null });
        };
        window.handleAddNewCoach = async () => {
            const name = prompt("Enter the new coach's name:");
            if (name && state.user) {
              await addDoc(collection(db, 'coaches'), { name, sessions: [], userId: state.user.uid });
            }
        };
        window.handleSaveSession = async (sessionData) => {
            const coachRef = doc(db, 'coaches', state.selectedCoachId);
            const coachToUpdate = state.coaches[state.selectedCoachId];
            const sessionIndex = coachToUpdate.sessions.findIndex(s => s.id === sessionData.id);
            let updatedSessions = sessionIndex > -1 
                ? coachToUpdate.sessions.map(s => s.id === sessionData.id ? sessionData : s)
                : [...coachToUpdate.sessions, sessionData];
            const updatedCoach = { ...coachToUpdate, sessions: updatedSessions };
            delete updatedCoach.id;
            await setDoc(coachRef, updatedCoach);
            setState({ currentView: 'coachDetail' });
        };

        // --- "COMPONENTS" (DOM element factories) ---
        function LoginScreen() {
            const el = document.createElement('div');
            el.className = 'flex flex-col justify-center items-center h-screen bg-gray-100 p-4';
            el.innerHTML = `
                <div class="login-card bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Coach Feedback App</h1>
                    <p class="text-gray-600 mb-6">Please enter the access code to continue.</p>
                    <input id="access-code" type="password" placeholder="Access Code" class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition mb-4">
                    <button onclick="handleLoginAttempt()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                        Enter
                    </button>
                    <p id="error-message" class="text-red-500 mt-4 h-5"></p>
                </div>
            `;
            // Add event listener for Enter key
            setTimeout(() => {
                const input = document.getElementById('access-code');
                if (input) {
                    input.addEventListener('keyup', (event) => {
                        if (event.key === 'Enter') {
                            handleLoginAttempt();
                        }
                    });
                }
            }, 0);
            return el;
        }

        function Header({ title, onBack, showLogout }) {
            return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center w-full sticky top-0 z-20">
                    <div class="flex items-center">
                        ${onBack ? `<button onclick="${onBack}" class="p-2 mr-4 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>` : ''}
                        <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                    </div>
                </header>`;
        }
        
        function CoachListScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            el.innerHTML = `
                ${Header({ title: "Rowing Coaches", showLogout: true })}
                <main class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.entries(state.coaches).map(([id, coach]) => `
                        <div onclick="handleSelectCoach('${id}')" class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-blue-500 rounded-full p-3 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${coach.name}</h3>
                                <p class="text-sm text-gray-500">${coach.sessions.length} session${coach.sessions.length !== 1 ? 's' : ''} recorded</p>
                            </div>
                        </div>`).join('')}
                    <button onclick="handleAddNewCoach()" class="bg-gray-100 p-4 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center justify-center text-gray-500 hover:text-blue-600">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="mt-2 font-semibold">Add New Coach</span>
                    </button>
                </main>`;
            return el;
        }
        
        function CoachDetailScreen() {
            const el = document.createElement('div');
            el.className = 'p-4 md:p-8';
            const coach = state.coaches[state.selectedCoachId];

            el.innerHTML = `
                ${Header({ title: coach.name, onBack: 'handleBack()' })}
                <main class="mt-8">
                    <div id="chart-container" class="bg-white p-6 rounded-lg shadow mb-8"></div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Session History</h2>
                        <button onclick="handleNewSession()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                             New Session
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${coach.sessions.length > 0 ? coach.sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(session => `
                            <div onclick='handleSelectSession(${JSON.stringify(session)})' class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer">
                                <p class="font-semibold text-gray-900">Session: ${new Date(session.date).toLocaleDateString('en-NZ', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-600 mt-1">Focus: ${session.focus}</p>
                            </div>`).join('') : `<p class="text-gray-500 md:col-span-2">No sessions recorded yet.</p>`
                        }
                    </div>
                </main>`;

            // Render Chart
            setTimeout(() => {
                const chartContainer = document.getElementById('chart-container');
                if (chartContainer && coach.sessions.length > 0) {
                     const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
                     const chartData = coach.sessions.map(session => {
                        const sessionData = { date: new Date(session.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) };
                        session.feedback.forEach(fb => { sessionData[fb.category] = fb.score; });
                        return sessionData;
                     });
                     const categories = Object.keys(rubricData);
                     const colors = ['#8884d8', '#82ca9d', '#ffc658', '#ff8042', '#0088FE'];

                     const chart = React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
                         React.createElement(BarChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                             React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                             React.createElement(XAxis, { dataKey: "date" }),
                             React.createElement(YAxis, { domain: [0, 5], allowDecimals: false }),
                             React.createElement(Tooltip, null),
                             React.createElement(Legend, null),
                             ...categories.map((cat, index) => React.createElement(Bar, { key: cat, dataKey: cat, fill: colors[index % colors.length], name: cat.replace("Understands ","")}))
                         )
                     );
                     chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Progress Over Time</h3>`;
                     const chartRoot = document.createElement('div');
                     chartRoot.style.width = '100%';
                     chartRoot.style.height = '400px';
                     chartContainer.appendChild(chartRoot);
                     ReactDOM.render(chart, chartRoot);
                } else if(chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }, 0);
            return el;
        }

        function SessionFeedbackScreen() {
             const el = document.createElement('div');
             el.className = 'p-4 md:p-8';
             const coach = state.coaches[state.selectedCoachId];
             let session = state.selectedSession || {
                id: `session-${Date.now()}`, date: new Date().toISOString().split('T')[0], focus: '',
                feedback: Object.keys(rubricData).map(cat => ({ category: cat, score: null, comments: '' })),
                summary: '', actionPlan: ''
             };
             
             el.innerHTML = `
                ${Header({ title: `${state.selectedSession ? 'Edit' : 'New'} Session for ${coach.name}`, onBack: 'handleBack()' })}
                <main id="session-form" class="mt-8">
                    <!-- form content will be injected here -->
                </main>
             `;

             // Build and attach form to avoid innerHTML event listener issues
             setTimeout(() => {
                const formContainer = document.getElementById('session-form');
                if(!formContainer) return;
                
                const formHTML = `
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="date" class="font-medium text-gray-700 block mb-2">Session Date:</label>
                                <input type="date" name="date" value="${session.date}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                            </div>
                            <div>
                                <label for="focus" class="font-medium text-gray-700 block mb-2">Session Focus:</label>
                                <input type="text" name="focus" value="${session.focus}" placeholder="e.g., Technical drills, race prep" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                            </div>
                        </div>
                    </div>
                    ${Object.entries(rubricData).map(([category, data]) => {
                        const currentFeedback = session.feedback.find(f => f.category === category) || { score: -1, comments: "" };
                        return `
                        <div class="bg-white p-6 rounded-lg shadow mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">${category}</h3>
                            <p class="text-sm text-gray-500">${data.description}</p>
                            <div class="mt-6">
                               <div class="flex justify-between text-xs text-gray-600 px-1 mb-4">
                                ${[...Array(6)].map((_, i) => `<button data-cat="${category}" data-score="${i}" class="score-btn w-10 h-10 flex items-center justify-center rounded-full transition-colors ${currentFeedback.score === i ? 'bg-blue-600 text-white font-bold' : 'bg-gray-200 hover:bg-blue-100'}">${i}</button>`).join('')}
                               </div>
                               <p class="text-gray-700 mb-4 h-12"><strong>Description: </strong><span id="desc-${category.replace(/\s+/g, '')}">${currentFeedback.score > -1 ? data.levels[currentFeedback.score] : "Select a rating."}</span></p>
                               <textarea name="comments" data-cat="${category}" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Add specific examples...">${currentFeedback.comments}</textarea>
                            </div>
                        </div>`
                    }).join('')}
                     <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Session Summary</h3>
                        <div>
                            <label for="summary" class="font-medium text-gray-700 block mb-2">Key Takeaways:</label>
                            <textarea name="summary" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.summary}</textarea>
                         </div>
                         <div class="mt-4">
                            <label for="actionPlan" class="font-medium text-gray-700 block mb-2">Action Plan / Next Steps:</label>
                            <textarea name="actionPlan" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${session.actionPlan}</textarea>
                         </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="save-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">Save Session Feedback</button>
                    </div>`;

                formContainer.innerHTML = formHTML;

                formContainer.querySelectorAll('.score-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.dataset.cat;
                        const score = parseInt(btn.dataset.score);
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        session.feedback[fbIndex].score = score;
                        
                        // Update UI
                        document.getElementById(`desc-${category.replace(/\s+/g, '')}`).textContent = rubricData[category].levels[score];
                        formContainer.querySelectorAll(`.score-btn[data-cat="${category}"]`).forEach(b => {
                            b.classList.toggle('bg-blue-600', parseInt(b.dataset.score) === score);
                            b.classList.toggle('text-white', parseInt(b.dataset.score) === score);
                            b.classList.toggle('font-bold', parseInt(b.dataset.score) === score);
                            b.classList.toggle('bg-gray-200', parseInt(b.dataset.score) !== score);
                        });
                    });
                });

                document.getElementById('save-btn').addEventListener('click', () => {
                    session.date = formContainer.querySelector('input[name="date"]').value;
                    session.focus = formContainer.querySelector('input[name="focus"]').value;
                    session.summary = formContainer.querySelector('textarea[name="summary"]').value;
                    session.actionPlan = formContainer.querySelector('textarea[name="actionPlan"]').value;
                    formContainer.querySelectorAll('textarea[name="comments"]').forEach(textarea => {
                        const category = textarea.dataset.cat;
                        const fbIndex = session.feedback.findIndex(f => f.category === category);
                        session.feedback[fbIndex].comments = textarea.value;
                    });
                    handleSaveSession(session);
                });

             }, 0);

             return el;
        }

        // --- INITIALIZATION ---
        function initializeFirebaseAndLoadData() {
            onAuthStateChanged(auth, (currentUser) => {
                if (currentUser) {
                    setState({ user: currentUser });
                    const coachesQuery = query(collection(db, 'coaches'), where("userId", "==", currentUser.uid));
                    onSnapshot(coachesQuery, (querySnapshot) => {
                        const coachesData = {};
                        querySnapshot.forEach((doc) => {
                            coachesData[doc.id] = { id: doc.id, ...doc.data() };
                        });
                        setState({ coaches: coachesData, loading: false, currentView: 'coachList' });
                    });
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }

        renderApp();
    </script>
</body>
</html>

